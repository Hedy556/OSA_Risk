<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSA風險評估量表</title>
    <style>
        
        /* 批量處理樣式 */body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f7f7f7;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            .patient-info {
                grid-template-columns: 1fr;
            }
            
            .parameter-row {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .parameter-guide {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .batch-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .results-summary {
                grid-template-columns: 1fr;
            }
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .assessment-form {
            margin-bottom: 0;
        }
        
        .patient-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .info-group {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .info-input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .parameter-section {
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .parameter-header {
            background: #87aabd;
            color: rgb(252, 251, 251);
            padding: 15px 20px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .parameter-content {
            padding: 20px;
        }
        
        .parameter-row {
            display: grid;
            grid-template-columns: 1fr 150px 80px 100px;
            gap: 15px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .parameter-row:last-child {
            border-bottom: none;
        }
        
        .parameter-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .parameter-input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
        }
        
        .parameter-score {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #495057;
        }
        
        .calculate-btn {
            background: #FF8C73;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: block;
            margin: 30px auto;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .clear-data-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: block;
            margin: 15px auto 30px auto;
        }

        .clear-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(149, 165, 166, 0.3);
            background: #7f8c8d;
        }

        .result-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
            display: none;
        }
        
        .total-score {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .risk-level {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .recommendation {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .scale-visual {
            margin: 30px 0;
            height: 60px;
            border-radius: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .scale-segments {
            display: flex;
            height: 100%;
        }
        
        .scale-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            /* 🔴 添加白色邊框 */
            border-right: 1px solid white;
        }

        /* 🔴 添加：最後一個不需要右邊框 */
        .scale-segment:last-child {
            border-right: none;
        }
        
        .seg-0 { background: #4A8F8F; }   /* 比基準點更深的低風險 */
        .seg-1 { background: #4F9494; }   /* 低風險過渡 */
        .seg-2 { background: #549A9A; }   /* 低風險基準點 */
        .seg-3 { background: #6FA2A2; }   /* 低→中過渡 */
        .seg-4 { background: #8AABAA; }   /* 低→中過渡 */
        .seg-5 { background: #A5B3B2; }   /* 低→中過渡 */
        .seg-6 { background: #B6BAB1; }   /* 接近中風險 */
        .seg-7 { background: #C8C0B1; }   /* 中風險基準點 */
        .seg-8 { background: #D0B8A8; }   /* 中→高過渡 */
        .seg-9 { background: #D8B09F; }   /* 中→高過渡 */
        .seg-10 { background: #E0A896; }  /* 中→高過渡 */
        .seg-11 { background: #E3A080; }  /* 中→高過渡 */
        .seg-12 { background: #E5846E; }  /* 高風險基準點 */
        .seg-13 { background: #E27A64; }  /* 高風險過渡 */
        .seg-14 { background: #DF705A; }  /* 最高風險 */
                
        .score-indicator {
            position: absolute;
            top: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid #2c3e50;
            transform: translateX(-50%);
            transition: left 0.5s ease;
        }
        
        .scoring-guide {
            margin-top: 40px;
            padding: 25px;
            background: #e8f4fd;
            border-radius: 15px;
            border-left: 6px solid #3498db;
        }
        
        .guide-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .guide-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .guide-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
        }
        
        .guide-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #bdc3c7;
        }
        
        .guide-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .parameter-guide {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .guide-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .guide-item-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 16px;
        }
        
        .guide-item-content {
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* 分頁樣式 */
        .tab-container {
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #7f8c8d;
        }
        
        .tab-button.active {
            background: #6C838F;
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #2c3e50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .batch-processing-section {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            border: 3px dashed #3498db;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section-header h3 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .section-header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .upload-area {
            background: white;
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #3498db;
        }
        
        .upload-text {
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .file-list {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #fef9e7;
            color: #f39c12;
        }
        
        .status-processing {
            background: #e3f2fd;
            color: #2196f3;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #4caf50;
        }
        
        .status-error {
            background: #ffebee;
            color: #f44336;
        }
        
        .batch-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .process-btn, .clear-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .process-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .process-btn:hover, .clear-btn:hover {
            transform: translateY(-2px);
        }
        
        .batch-results {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid;
        }
        
        .summary-card.no-risk {
            border-left-color: #27ae60;
        }
        
        .summary-card.medium-risk {
            border-left-color: #f39c12;
        }
        
        .summary-card.high-risk {
            border-left-color: #e74c3c;
        }
        
        .summary-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .results-table {
            overflow-x: auto;
        }
        
        .results-table table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .results-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .results-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #bdc3c7;
            font-size: 14px;
        }
        
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .risk-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .risk-badge.no-risk {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .risk-badge.medium-risk {
            background: #fef9e7;
            color: #f39c12;
        }
        
        .risk-badge.high-risk {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .divider {
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            color: #7f8c8d;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #bdc3c7, transparent);
        }
        
        .divider span {
            background: white;
            padding: 0 20px;
        }

        .export-excel-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .export-excel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(46, 204, 113, 0.3);
        }

        .progress-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-info span:first-child {
            color: #2c3e50;
            font-size: 16px;
        }

        .progress-info span:last-child {
            color: #3498db;
            font-size: 18px;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255,255,255,0.2) 50%, 
                rgba(255,255,255,0.2) 75%, 
                transparent 75%, 
                transparent);
            background-size: 20px 20px;
            animation: progress-stripes 1s linear infinite;
        }

        @keyframes progress-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .progress-details {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
            line-height: 1.4;
        }

        .progress-details .current-file {
            color: #2c3e50;
            font-weight: bold;
        }

        .file-scroll-container {
            max-height: 400px; /* 大約可顯示10個文件項目的高度 */
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 5px;
        }

        /* 自定義滾動條樣式 */
        .file-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .file-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .file-scroll-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .file-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        /* 滾動提示 */
        .file-scroll-container::after {
            content: '';
            display: block;
            height: 1px;
        }

        /* 當文件超過容器高度時顯示漸變效果 */
        .file-scroll-container.has-scroll {
            position: relative;
        }

        .file-scroll-container.has-scroll::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 8px; /* 避免覆蓋滾動條 */
            height: 20px;
            background: linear-gradient(transparent, rgba(248, 249, 250, 0.8));
            pointer-events: none;
            z-index: 1;
        }

        /* 優化文件項目在滾動容器中的顯示 */
        .file-scroll-container .file-item {
            margin: 5px;
            background: white;
        }

        .file-scroll-container .file-item:hover {
            transform: none; /* 在滾動容器中不要有過多的動畫效果 */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .export-image-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: block;
            margin: 15px auto;
        }

        .export-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">OSA風險評估量表</div>
            <div class="subtitle">阻塞性睡眠呼吸中止症篩檢工具</div>
        </div>
        
        <div class="content">
            <!-- 分頁容器 -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('single')">
                        🏥 單一檢測
                    </button>
                    <button class="tab-button" onclick="switchTab('batch')">
                        📄 批量分析
                    </button>
                </div>
                
                <!-- 單一檢測分頁 -->
                <div id="singleTab" class="tab-content active">
                    <div class="assessment-form">
                        <div class="patient-info">
                            <div class="info-group">
                                <label class="info-label">姓名：</label>
                                <input type="text" class="info-input" id="patientName" placeholder="請輸入姓名">
                            </div>
                            <div class="info-group">
                                <label class="info-label">檢查日期：</label>
                                <input type="date" class="info-input" id="assessmentDate">
                            </div>
                        </div>
                        
                        <div class="parameter-section">
                            <div class="parameter-header">ODI 3% (氧氣不飽和指數)</div>
                            <div class="parameter-content">
                                <div class="parameter-row">
                                    <div class="parameter-label">ODI 3% 數值</div>
                                    <input type="number" class="parameter-input" id="odi3" placeholder="輸入數值" min="0" max="100">
                                    <div class="parameter-score" id="odi3Score">0</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">最重要指標</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="parameter-section">
                            <div class="parameter-header">最小血氧飽和度 (SpO2)</div>
                            <div class="parameter-content">
                                <div class="parameter-row">
                                    <div class="parameter-label">最小 SpO2 (%)</div>
                                    <input type="number" class="parameter-input" id="minSpo2" placeholder="輸入百分比" min="0" max="100">
                                    <div class="parameter-score" id="spo2Score">0</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">次重要指標</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="parameter-section">
                            <div class="parameter-header">T90 (血氧<90%時間比例)</div>
                            <div class="parameter-content">
                                <div class="parameter-row">
                                    <div class="parameter-label">T90 (%)</div>
                                    <input type="number" class="parameter-input" id="t90" placeholder="輸入百分比" min="0" max="100">
                                    <div class="parameter-score" id="t90Score">0</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">輔助指標</div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="calculate-btn" onclick="calculateRisk()">計算風險等級</button>
                        <button class="clear-data-btn" onclick="clearSingleAssessmentData()">🗑️ 清空數據</button>
                    </div>
                    
                    <div class="result-section" id="resultSection">
                        <div id="patientInfoForExport" style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 10px; font-size: 14px;">
                            <strong>患者：</strong><span id="displayPatientName">-</span> | 
                            <strong>檢查日期：</strong><span id="displayAssessmentDate">-</span>
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">評估結果</h3>
                        <div class="total-score" id="totalScore">0</div>
                        <div style="font-size: 16px; color: #7f8c8d; margin-bottom: 15px;">總分</div>
                        
                        <div class="scale-visual">
                            <div class="scale-segments">
                                <div class="scale-segment seg-0">0</div>
                                <div class="scale-segment seg-1">1</div>
                                <div class="scale-segment seg-2">2</div>
                                <div class="scale-segment seg-3">3</div>
                                <div class="scale-segment seg-4">4</div>
                                <div class="scale-segment seg-5">5</div>
                                <div class="scale-segment seg-6">6</div>
                                <div class="scale-segment seg-7">7</div>
                                <div class="scale-segment seg-8">8</div>
                                <div class="scale-segment seg-9">9</div>
                                <div class="scale-segment seg-10">10</div>
                                <div class="scale-segment seg-11">11</div>
                                <div class="scale-segment seg-12">12</div>
                                <div class="scale-segment seg-13">13</div>
                                <div class="scale-segment seg-14">14</div>
                            </div>
                            <div class="score-indicator" id="scoreIndicator"></div>
                        </div>
                        
                        <div class="risk-level" id="riskLevel">-</div>
                        <div class="recommendation" id="recommendation">
                            <h4 style="margin-top: 0; color: #2c3e50;">建議處置</h4>
                            <p id="recommendationText">請先進行評估</p>
                        </div>
                        <button class="export-image-btn" onclick="exportResultAsImage()">📷 匯出結果圖片</button>
                    </div>
                </div>
                
                <!-- 批量分析分頁 -->
                <div id="batchTab" class="tab-content">
                    <div class="batch-processing-section">
                        <div class="section-header">
                            <h3>📄 智能批量PDF分析</h3>
                            <p>直接分析OSA檢測報告PDF，智能提取關鍵數據並計算風險等級</p>
                        </div>
                        
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <div class="upload-icon">📄</div>
                                <div class="upload-text">
                                    <strong>拖曳PDF文件到此處或點擊選擇</strong><br>
                                    <span>支援多檔案同時上傳</span><br>
                                    <small style="color: #7f8c8d;">系統會自動轉換PDF為Excel並讀取數據</small>
                                </div>
                                <input type="file" id="pdfFiles" multiple accept=".pdf" style="display: none;">
                                <button class="upload-btn" onclick="document.getElementById('pdfFiles').click()">選擇PDF文件</button>
                            </div>
                        </div>
                        
                        <div class="file-list" id="fileList" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">已上傳的文件：</h4>
                                <span id="fileCount" style="color: #7f8c8d; font-size: 14px;"></span>
                            </div>
                            <div class="file-scroll-container">
                                <div id="uploadedFiles"></div>
                            </div>
                            <div class="batch-actions">
                                <button class="process-btn" onclick="processPDFs()">🔍 開始分析</button>
                                <button class="clear-btn" onclick="clearFiles()">🗑️清空文件</button>
                            </div>
                            
                            <!-- 添加進度條 -->
                            <div class="progress-container" id="progressContainer" style="display: none;">
                                <div class="progress-info">
                                    <span id="progressText">準備中...</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-details" id="progressDetails"></div>
                            </div>
                        </div>
                        
                        <div class="batch-results" id="batchResults" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="margin: 0;">分析結果：</h4>
                                <button class="export-excel-btn" onclick="exportToExcel()">📊 匯出Excel</button>
                            </div>
                            <div class="results-summary" id="resultsSummary"></div>
                            <div class="results-table" id="resultsTable"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="scoring-guide">
                <div class="guide-title">📋 評分標準說明</div>
                
                <div class="parameter-guide">
                    <div class="guide-item">
                        <div class="guide-item-title">🔴 ODI 3% 評分</div>
                        <div class="guide-item-content">
                            <strong>≥25：</strong> 6分<br>
                            <strong>15-24：</strong> 5分<br>
                            <strong>10-14：</strong> 4分<br>
                            <strong>5-9：</strong> 3分<br>
                            <strong>3-4：</strong> 2分<br>
                            <strong>1-2：</strong> 1分<br>
                            <strong>0：</strong> 0分
                        </div>
                    </div>
                    
                    <div class="guide-item">
                        <div class="guide-item-title">🟠 最小SpO2評分</div>
                        <div class="guide-item-content">
                            <strong>&lt;70%：</strong> 5分<br>
                            <strong>70-74%：</strong> 4分<br>
                            <strong>75-79%：</strong> 3分<br>
                            <strong>80-84%：</strong> 2分<br>
                            <strong>85-87%：</strong> 1分<br>
                            <strong>≥88%：</strong> 0分
                        </div>
                    </div>
                    
                    <div class="guide-item">
                        <div class="guide-item-title">🟡 T90 評分</div>
                        <div class="guide-item-content">
                            <strong>&gt;15%：</strong> 4分<br>
                            <strong>11-15%：</strong> 3分<br>
                            <strong>6-10%：</strong> 2分<br>
                            <strong>1-5%：</strong> 1分<br>
                            <strong>0%：</strong> 0分
                        </div>
                    </div>
                </div>
                
                <table class="guide-table">
                    <thead>
                        <tr>
                            <th>風險等級</th>
                            <th>總分範圍</th>
                            <th>建議處置</th>
                            <th>追蹤頻率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #d5f4e6;">
                            <td><strong>低風險</strong></td>
                            <td>0-3分</td>
                            <td>年度定期追蹤</td>
                            <td>12個月</td>
                        </tr>
                        <tr style="background: #fef9e7;">
                            <td><strong>中度風險</strong></td>
                            <td>4-7分</td>
                            <td>生活型態調整</td>
                            <td>3-6個月</td>
                        </tr>
                        <tr style="background: #fadbd8;">
                            <td><strong>高度風險</strong></td>
                            <td>8-14分</td>
                            <td>立即轉介專科</td>
                            <td>依醫師指示</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // 載入PDF.js庫
        const pdfScript = document.createElement('script');
        pdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        document.head.appendChild(pdfScript);
        
        // 載入html2canvas庫
        function loadHtml2Canvas() {
            if (typeof html2canvas === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = function() {
                    console.log('html2canvas 庫載入完成');
                };
                document.head.appendChild(script);
            }
        }

        // 頁面載入時載入庫
        loadHtml2Canvas();

        // 載入SheetJS庫用於Excel匯出
        const xlsxScript = document.createElement('script');
        xlsxScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        document.head.appendChild(xlsxScript);

        // 設定今天的日期為預設值
        document.getElementById('assessmentDate').valueAsDate = new Date();
        
        // 清空單一檢測數據的函數
        function clearSingleAssessmentData() {
            // 清空輸入欄位
            document.getElementById('patientName').value = '';
            document.getElementById('odi3').value = '';
            document.getElementById('minSpo2').value = '';
            document.getElementById('t90').value = '';
            
            // 重置分數顯示
            document.getElementById('odi3Score').textContent = '0';
            document.getElementById('spo2Score').textContent = '0';
            document.getElementById('t90Score').textContent = '0';
            
            // 隱藏結果區域
            document.getElementById('resultSection').style.display = 'none';
            
            // 重設檢查日期為今天
            document.getElementById('assessmentDate').valueAsDate = new Date();
        }

        // 分頁切換功能
        function switchTab(tabName) {
            // 隱藏所有分頁內容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有按鈕的active狀態
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 顯示選中的分頁
            if (tabName === 'single') {
                document.getElementById('singleTab').classList.add('active');
                document.querySelector('.tab-button:first-child').classList.add('active');
                
                // 清空單一檢測的數據
                clearSingleAssessmentData();
                
            } else if (tabName === 'batch') {
                document.getElementById('batchTab').classList.add('active');
                document.querySelector('.tab-button:last-child').classList.add('active');
            }
        }
        
        // 批量處理相關變數
        let uploadedFiles = [];
        let processedResults = [];
        
        // 拖曳上傳功能
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('pdfFiles');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            handleFileUpload(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileUpload(files);
        });
        
        async function exportResultAsImage() {
            const resultElement = document.getElementById('resultSection');
            
            if (!resultElement || resultElement.style.display === 'none') {
                alert('請先進行風險評估！');
                return;
            }
            
            try {
                // 等待html2canvas庫載入
                if (typeof html2canvas === 'undefined') {
                    alert('圖片匯出功能正在載入中，請稍後再試...');
                    return;
                }
                
                // 獲取患者資訊
                const patientName = document.getElementById('patientName').value || '未知患者';
                const assessmentDate = document.getElementById('assessmentDate').value || '未知日期';
                
                // 截圖選項
                const options = {
                    backgroundColor: '#ffffff',
                    scale: 2, // 高解析度
                    useCORS: true,
                    allowTaint: true,
                    width: resultElement.offsetWidth,
                    height: resultElement.offsetHeight
                };
                
                // 生成截圖
                const canvas = await html2canvas(resultElement, options);
                
                // 創建下載連結
                const link = document.createElement('a');
                link.download = `OSA風險評估結果_${patientName}_${assessmentDate}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // 觸發下載
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('匯出圖片時發生錯誤:', error);
                alert('匯出圖片失敗，請重試！');
            }
        }

        function handleFileUpload(files) {
            uploadedFiles = [...uploadedFiles, ...files];
            displayUploadedFiles();
            document.getElementById('fileList').style.display = 'block';
        }
        
        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            const scrollContainer = container.parentElement;
            const fileCountSpan = document.getElementById('fileCount');
            
            // 清空容器
            container.innerHTML = '';
            
            // 更新文件數量顯示
            fileCountSpan.textContent = `共 ${uploadedFiles.length} 個文件`;
            
            // 創建所有文件項目
            uploadedFiles.forEach((file, index) => {
                const fileItem = createFileItem(file, index);
                container.appendChild(fileItem);
            });
            
            // 檢查是否需要滾動，添加漸變效果
            setTimeout(() => {
                if (container.scrollHeight > scrollContainer.clientHeight) {
                    scrollContainer.classList.add('has-scroll');
                } else {
                    scrollContainer.classList.remove('has-scroll');
                }
            }, 100);
        }

        function createFileItem(file, index) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <span>📄</span>
                    <span>${file.name}</span>
                    <span class="file-size">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                </div>
                <div>
                    <span class="file-status status-pending" id="status-${index}">等待處理</span>
                    <button onclick="removeFile(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer;">✕</button>
                </div>
            `;
            return fileItem;
        }

        function createFileItem(file, index) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <span>📄</span>
                    <span>${file.name}</span>
                    <span class="file-size">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                </div>
                <div>
                    <span class="file-status status-pending" id="status-${index}">等待處理</span>
                    <button onclick="removeFile(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer;">✕</button>
                </div>
            `;
            return fileItem;
        }
        
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayUploadedFiles();
            if (uploadedFiles.length === 0) {
                document.getElementById('fileList').style.display = 'none';
            }
        }
        
        function clearFiles() {
            uploadedFiles = [];
            processedResults = [];
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('batchResults').style.display = 'none';
        }
        
        async function processPDFs() {
            if (uploadedFiles.length === 0) {
                alert('請先上傳PDF文件');
                return;
            }
            
            // 顯示進度條
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');
            
            // 初始化進度條
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressText.textContent = '準備開始分析...';
            progressDetails.innerHTML = `準備處理 ${uploadedFiles.length} 個PDF文件`;
            
            // 清空之前的結果
            processedResults = [];
            
            const totalFiles = uploadedFiles.length;
            let completedFiles = 0;
            
            for (let i = 0; i < totalFiles; i++) {
                const currentFile = uploadedFiles[i];
                const statusElement = document.getElementById(`status-${i}`);
                
                // 更新當前文件信息
                progressText.textContent = `正在分析: ${currentFile.name}`;
                progressDetails.innerHTML = `
                    <div class="current-file">當前: ${currentFile.name}</div>
                    <div>進度: ${completedFiles} / ${totalFiles} 個文件已完成</div>
                `;
                
                // 更新狀態為處理中
                statusElement.textContent = '分析中...';
                statusElement.className = 'file-status status-processing';
                
                try {
                    // 處理PDF
                    const result = await processPDF(currentFile, statusElement);
                    processedResults.push(result);
                    
                    // 成功處理
                    statusElement.textContent = '✅ 完成';
                    statusElement.className = 'file-status status-success';
                    
                } catch (error) {
                    console.error('處理PDF時出錯:', error);
                    
                    // 處理失敗
                    statusElement.textContent = '❌ 失敗';
                    statusElement.className = 'file-status status-error';
                    
                    processedResults.push({
                        fileName: currentFile.name,
                        error: true,
                        errorMessage: error.message
                    });
                }
                
                // 更新完成數量和進度條
                completedFiles++;
                const progress = Math.round((completedFiles / totalFiles) * 100);
                progressFill.style.width = progress + '%';
                progressPercent.textContent = progress + '%';
                
            }
            
            // 所有文件處理完成
            const successCount = processedResults.filter(r => !r.error).length;
            const errorCount = processedResults.filter(r => r.error).length;
            
            progressText.textContent = '🎉 分析完成！';
            progressDetails.innerHTML = `
                <div style="color: #27ae60;">✅ 成功: ${successCount} 個文件</div>
                ${errorCount > 0 ? `<div style="color: #e74c3c;">❌ 失敗: ${errorCount} 個文件</div>` : ''}
                <div>總計處理: ${totalFiles} 個文件</div>
            `;
            
            // 顯示結果
            displayBatchResults();
            
            // 3秒後隱藏進度條
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
        }
        
        async function processPDF(file, statusElement) {
            return new Promise(async (resolve, reject) => {
                try {
                    // 第一步：讀取並解析PDF
                    statusElement.textContent = '📖 讀取PDF...';
                    const pdfData = await readPDFFile(file);
                    
                    // 第二步：提取關鍵數據
                    statusElement.textContent = '🔍 提取數據...';
                    const extractedData = extractDataFromPDFText(pdfData.text, file.name);
                    
                    // 第三步：計算風險等級
                    statusElement.textContent = '⚖️ 計算風險...';
                    const result = calculateRiskFromExtractedData(extractedData, file.name);
                    
                    resolve(result);
                    
                } catch (error) {
                    reject(new Error(`PDF分析失敗: ${error.message}`));
                }
            });
        }
        
        async function readPDFFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        // 等待PDF.js庫載入
                        if (typeof pdfjsLib === 'undefined') {
                            // 如果PDF.js還沒載入，等待一下
                            setTimeout(() => readPDFFile(file).then(resolve).catch(reject), 1000);
                            return;
                        }
                        
                        const typedArray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        
                        let fullText = '';
                        let pageTexts = []; // 儲存每頁的文字
                        
                        // 讀取所有頁面的文字內容
                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();
                            
                            // 更仔細地組合文字，保留更多空格和結構
                            let pageText = '';
                            textContent.items.forEach((item, index) => {
                                // 添加空格來分隔文字項目
                                if (index > 0) {
                                    pageText += ' ';
                                }
                                pageText += item.str;
                            });
                            
                            pageTexts.push(pageText);
                            fullText += `\n=== 第${pageNum}頁 ===\n${pageText}\n`;
                        }
                        
                        console.log('=== PDF讀取詳情 ===');
                        console.log('總頁數:', pdf.numPages);
                        console.log('各頁文字長度:', pageTexts.map((text, i) => `第${i+1}頁: ${text.length}字`));
                        
                        // 顯示每頁的開頭部分
                        pageTexts.forEach((text, i) => {
                            console.log(`第${i+1}頁前200字:`, text.substring(0, 200));
                        });
                        
                        resolve({
                            text: fullText,
                            pageTexts: pageTexts,
                            numPages: pdf.numPages
                        });
                        
                    } catch (error) {
                        console.error('PDF解析錯誤:', error);
                        reject(new Error(`PDF解析失敗: ${error.message}`));
                    }
                };
                reader.onerror = function() {
                    reject(new Error('PDF檔案讀取失敗'));
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function convertPDFToExcel(pdfData, fileName) {
            return new Promise((resolve, reject) => {
                try {
                    // 從PDF文字中提取關鍵數據
                    const extractedData = extractDataFromPDFText(pdfData.text, fileName);
                    resolve(extractedData);
                } catch (error) {
                    reject(new Error(`數據提取失敗: ${error.message}`));
                }
            });
        }
        
        function extractDataFromPDFText(pdfText, fileName) {
            console.log('=== 開始PDF數據提取 (Soosyn格式 - 智能優先級版本) ===');
            console.log('檔案名稱:', fileName);
            console.log('PDF內容預覽:', pdfText.substring(0, 300));
            
            const result = {
                patientName: null,
                recordTime: null,
                printDate: null,
                odi3: null,
                minSpo2: null,
                t90: null
            };
            
            // 1. 提取患者姓名 - "姓名 : 吳文彬"
            const namePatterns = [
                /姓名\s*[:：]\s*([^\s\n\r病歷號]+)/i,
                /姓名.*?[:：]\s*([^\s\n\r]+)/i
            ];
            
            for (const pattern of namePatterns) {
                const match = pdfText.match(pattern);
                if (match && !result.patientName) {
                    let name = match[1].trim();
                    // 清理姓名中的多餘文字
                    name = name.replace(/身高.*|病.*|纖維.*|工廠.*|-.*/, '').trim();
                    if (name.length > 0 && name.length <= 10) {
                        result.patientName = name;
                        console.log('✅ 找到姓名:', result.patientName);
                        break;
                    }
                }
            }
            
            // 2. 提取記錄時間 - "記錄時間 : 2025/4/1 22:31 - 2025/4/2 6:13"
            const recordTimePatterns = [
                /記錄時間\s*[:：]\s*([0-9/:\s-]+)/i,
                /記錄時間.*?[:：]\s*([0-9/:\s-]+)/i
            ];
            
            for (const pattern of recordTimePatterns) {
                const match = pdfText.match(pattern);
                if (match && !result.recordTime) {
                    result.recordTime = match[1].trim();
                    console.log('✅ 找到記錄時間:', result.recordTime);
                    break;
                }
            }
            
            // 3. 提取列印日期 - "列印日期 : 2025年04月21日"
            const printDatePatterns = [
                /列印日期\s*[:：]\s*([0-9年月日]+)/i,
                /列印日期.*?[:：]\s*([0-9年月日]+)/i
            ];
            
            for (const pattern of printDatePatterns) {
                const match = pdfText.match(pattern);
                if (match && !result.printDate) {
                    result.printDate = match[1].trim();
                    console.log('✅ 找到列印日期:', result.printDate);
                    break;
                }
            }
            
            // 4. 智能提取ODI 3% - 按優先級順序提取
            console.log('\n🔍 智能提取ODI 3% (按優先級)');
            
            // 優先級1: 結論性評估數據 (最高優先級)
            const odi3ConclusionPatterns = [
                /ODI3%=(\d+)/i,
                /ODI\s*3%\s*=\s*(\d+)/i
            ];
            
            for (const pattern of odi3ConclusionPatterns) {
                const match = pdfText.match(pattern);
                if (match) {
                    result.odi3 = parseInt(match[1]);
                    console.log('✅ [優先級1] 從結論提取ODI 3%:', result.odi3, '- 來源:', match[0]);
                    break;
                }
            }
            
            // 優先級2: 表格主要數據 (如果沒找到結論數據)
            if (result.odi3 === null) {
                const odi3TablePatterns = [
                    /ODI\s*3%\s+(\d+)\s*次.*?\d+\s*次\s*每小時/i,
                    /ODI\s*3%\s+(\d+)\s*次/i
                ];
                
                for (const pattern of odi3TablePatterns) {
                    const match = pdfText.match(pattern);
                    if (match) {
                        const value = parseInt(match[1]);
                        if (value >= 0 && value <= 200) {
                            result.odi3 = value;
                            console.log('✅ [優先級2] 從表格提取ODI 3%:', result.odi3, '- 來源:', match[0]);
                            break;
                        }
                    }
                }
            }
            
            // 優先級3: 頻率數據 (最後選擇)
            if (result.odi3 === null) {
                const odi3FrequencyPatterns = [
                    /每小時\s*ODI\s*3%\s*頻率\s+([0-9]+\.?[0-9]*)/i,
                    /每小時.*?ODI.*?3%.*?(\d+\.?\d*)/i
                ];
                
                for (const pattern of odi3FrequencyPatterns) {
                    const match = pdfText.match(pattern);
                    if (match) {
                        const value = parseFloat(match[1]);
                        if (value >= 0 && value <= 200) {
                            result.odi3 = value;
                            console.log('⚠️ [優先級3] 從頻率提取ODI 3%:', result.odi3, '- 來源:', match[0]);
                            console.log('注意：這可能不是用於風險評估的正確數值');
                            break;
                        }
                    }
                }
            }
            
            // 5. 提取T90 - 將"T90 (SpO2 < 90%)"視為關鍵詞，提取後面第一個儲存格數值
            console.log('\n🔍 提取T90 - 關鍵詞匹配模式');
            
            // 優先級1: 從結論提取
            const t90ConclusionMatch = pdfText.match(/T90=(\d+)%/i);
            if (t90ConclusionMatch) {
                result.t90 = parseInt(t90ConclusionMatch[1]);
                console.log('✅ [優先級1] 從結論提取T90:', result.t90, '- 來源:', t90ConclusionMatch[0]);
            }
            
            // 優先級2: 關鍵詞匹配 - "T90 (SpO2 < 90%)" 後面第一個數值
            if (result.t90 === null) {
                console.log('🔍 使用關鍵詞匹配: "T90 (SpO2 < 90%)" + 第一個數值');
                
                // 將"T90 (SpO2 < 90%)"視為固定關鍵詞，提取後面第一個數字
                const t90KeywordMatch = pdfText.match(/T90\s*\(\s*SpO2\s*<\s*90%\s*\)\s+(\d+)/i);
                
                if (t90KeywordMatch) {
                    const firstNumber = parseInt(t90KeywordMatch[1]);
                    console.log('關鍵詞匹配結果:', t90KeywordMatch[0]);
                    console.log('第一個數值:', firstNumber);
                    
                    // 直接採用第一個數值，但檢查合理性
                    if (firstNumber >= 0 && firstNumber <= 100) {
                        result.t90 = firstNumber;
                        console.log('✅ [優先級2] 關鍵詞匹配T90:', result.t90, '%');
                    } else {
                        console.log('⚠️ 第一個數值超出合理範圍(0-100):', firstNumber);
                    }
                } else {
                    console.log('❌ 未找到T90關鍵詞匹配');
                }
            }
            
            // 優先級3: 備用模式
            if (result.t90 === null) {
                console.log('🔄 使用備用模式提取T90');
                const t90BackupPatterns = [
                    /T90.*?(\d+)\s*%/i,
                    /T90.*?(\d+)/i
                ];
                
                for (const pattern of t90BackupPatterns) {
                    const match = pdfText.match(pattern);
                    if (match) {
                        const val = parseInt(match[1]);
                        if (val >= 0 && val <= 100) {
                            result.t90 = val;
                            console.log('✅ [備用模式] 提取T90:', result.t90, '- 來源:', match[0]);
                            break;
                        }
                    }
                }
            }
            
            // 6. 提取最小SpO2 - 超強多重模式匹配，處理各種複雜格式
            console.log('\n🔍 提取最小SpO2 - 超強多重模式匹配');
            
            // 優先級1: 從結論提取
            const spo2ConclusionMatch = pdfText.match(/最低SpO2=(\d+)%/i);
            if (spo2ConclusionMatch) {
                result.minSpo2 = parseInt(spo2ConclusionMatch[1]);
                console.log('✅ [優先級1] 從結論提取SpO2:', result.minSpo2, '- 來源:', spo2ConclusionMatch[0]);
            }
            
            // 優先級2: 超強多重模式階層式匹配
            if (result.minSpo2 === null) {
                console.log('🔍 使用超強多重模式匹配SpO2');
                
                const spo2SuperPatterns = [
                    {
                        name: "標準中文格式",
                        pattern: /最[小低]\s*SpO2\s*[：:=]?\s*\(?(\d+)/i,
                        description: "最小/最低 SpO2，支援標點符號和括號"
                    },
                    {
                        name: "英文格式", 
                        pattern: /(?:Min|minimum|Minimal|Lowest)\s*SpO2\s*[：:=]?\s*\(?(\d+)/i,
                        description: "Min/minimum/Minimal/Lowest SpO2"
                    },
                    {
                        name: "編碼容錯格式",
                        pattern: /最[小低]\s*Sp[O0oQ][2２２2]\s*[：:=]?\s*\(?(\d+)/i,
                        description: "容錯O/0/o/Q和2/２的編碼問題"
                    },
                    {
                        name: "後置格式",
                        pattern: /SpO2\s*最[小低]值?\s*[：:=]?\s*\(?(\d+)/i,
                        description: "SpO2最小值/最低值格式"
                    },
                    {
                        name: "表格序列格式",
                        pattern: /平均\s*SpO2.*?最大\s*SpO2.*?最[小低]\s*SpO2\s*[：:=]?\s*\(?(\d+)/i,
                        description: "完整表格序列"
                    },
                    {
                        name: "緊湊表格格式",
                        pattern: /平均SpO2\s*[\d.]+\s*最大SpO2\s*\d+\s*最[小低]SpO2\s*(\d+)/i,
                        description: "無空格緊湊表格"
                    },
                    {
                        name: "分隔符格式",
                        pattern: /最[小低]\s*SpO2[\s\|,\t]*(\d+)/i,
                        description: "各種分隔符格式"
                    },
                    {
                        name: "範圍值格式",
                        pattern: /最[小低]\s*SpO2\s*[：:=]?\s*(\d+)[-~]\d+/i,
                        description: "範圍值，取第一個數"
                    },
                    {
                        name: "帶單位格式",
                        pattern: /最[小低]\s*SpO2\s*[：:=]?\s*(\d+)\s*[%％]/i,
                        description: "明確標註百分比符號"
                    },
                    {
                        name: "換行分隔格式",
                        pattern: /最[小低]\s*SpO2\s*\n\s*(\d+)/i,
                        description: "換行分隔的數值"
                    },
                    {
                        name: "血氧飽和度格式",
                        pattern: /(?:血氧飽和度|氧飽和度)\s*最[小低]\s*[：:=]?\s*(\d+)/i,
                        description: "中文血氧飽和度表達"
                    },
                    {
                        name: "Saturation格式",
                        pattern: /(?:oxygen\s*saturation|O2\s*saturation)\s*(?:min|minimum|lowest)\s*[：:=]?\s*(\d+)/i,
                        description: "英文血氧飽和度"
                    },
                    {
                        name: "倒序格式",
                        pattern: /(\d+)\s*[：:=]?\s*最[小低]\s*SpO2/i,
                        description: "數值在前的倒序格式"
                    },
                    {
                        name: "括號內格式",
                        pattern: /SpO2\s*\([^)]*最[小低][^)]*(\d+)[^)]*\)/i,
                        description: "括號內的描述格式"
                    },
                    {
                        name: "全形字符格式",
                        pattern: /最[小低]　ＳｐＯ２\s*[：:=]?\s*(\d+)/i,
                        description: "全形字符格式"
                    },
                    {
                        name: "簡寫格式",
                        pattern: /min\s*SpO2\s*[：:=]?\s*(\d+)/i,
                        description: "min SpO2簡寫"
                    },
                    {
                        name: "模糊數字匹配",
                        pattern: /(?:最[小低]|Min|minimum).*?(?:SpO2|Sp02|血氧).*?(\d+)/i,
                        description: "模糊匹配關鍵詞和數字"
                    },
                    {
                        name: "表格列格式",
                        pattern: /最[小低].*?\n.*?SpO2.*?\n.*?(\d+)/i,
                        description: "多行表格列格式"
                    },
                    {
                        name: "數值優先格式",
                        pattern: /(\d{2})\s*(?:%|％)?\s*(?:最[小低])?.*?SpO2/i,
                        description: "以兩位數開頭的格式"
                    }
                ];
                
                for (let i = 0; i < spo2SuperPatterns.length; i++) {
                    const patternInfo = spo2SuperPatterns[i];
                    const match = pdfText.match(patternInfo.pattern);
                    
                    if (match) {
                        const val = parseInt(match[1]);
                        console.log(`匹配模式${i+1}: ${patternInfo.name}`);
                        console.log(`匹配結果: "${match[0]}" → 數值: ${val}`);
                        
                        // 數值合理性檢查
                        if (val >= 50 && val <= 100) {
                            result.minSpo2 = val;
                            console.log(`✅ [優先級2-模式${i+1}] 提取SpO2:`, result.minSpo2, '%');
                            break;
                        } else if (val >= 0 && val <= 50) {
                            // 可能是小數格式 0.74 -> 74
                            const possibleVal = val * 100;
                            if (possibleVal >= 50 && possibleVal <= 100) {
                                result.minSpo2 = possibleVal;
                                console.log(`✅ [優先級2-模式${i+1}] 小數轉換SpO2: ${val} → ${possibleVal}%`);
                                break;
                            } else {
                                console.log(`⚠️ 數值${val}轉換後仍超出範圍，繼續嘗試其他模式`);
                            }
                        } else {
                            console.log(`⚠️ 數值${val}超出合理範圍(50-100)，繼續嘗試其他模式`);
                        }
                    } else {
                        console.log(`模式${i+1} (${patternInfo.name}): 未匹配`);
                    }
                }
            }
            
            // 優先級3: 極端情況的暴力匹配
            if (result.minSpo2 === null) {
                console.log('🔄 使用極端情況暴力匹配SpO2');
                
                // 提取所有可能的兩位數字，然後基於上下文判斷
                const numberMatches = [...pdfText.matchAll(/(\d{2,3})/g)];
                const contextualNumbers = [];
                
                numberMatches.forEach((match, index) => {
                    const number = parseInt(match[1]);
                    const startPos = match.index;
                    const endPos = startPos + match[0].length;
                    
                    // 提取數字前後的上下文
                    const beforeContext = pdfText.substring(Math.max(0, startPos - 50), startPos).toLowerCase();
                    const afterContext = pdfText.substring(endPos, Math.min(pdfText.length, endPos + 50)).toLowerCase();
                    const fullContext = beforeContext + afterContext;
                    
                    // 檢查上下文是否包含SpO2相關關鍵詞
                    const hasSpO2Context = /spo2|sp02|血氧|oxygen|saturation/.test(fullContext);
                    const hasMinContext = /最小|最低|min|minimum|lowest/.test(fullContext);
                    
                    if (hasSpO2Context && hasMinContext && number >= 50 && number <= 100) {
                        contextualNumbers.push({
                            number,
                            context: fullContext,
                            confidence: (hasSpO2Context ? 1 : 0) + (hasMinContext ? 1 : 0)
                        });
                    }
                });
                
                if (contextualNumbers.length > 0) {
                    // 選擇信心度最高的數字
                    const bestMatch = contextualNumbers.sort((a, b) => b.confidence - a.confidence)[0];
                    result.minSpo2 = bestMatch.number;
                    console.log(`✅ [極端匹配] 基於上下文提取SpO2: ${result.minSpo2}% (信心度: ${bestMatch.confidence})`);
                    console.log(`上下文: "${bestMatch.context.trim()}"`);
                }
            }
            
            // 優先級4: 如果仍然找不到，詳細調試分析
            if (result.minSpo2 === null) {
                console.log('⚠️ 所有SpO2匹配模式都失敗，進行詳細調試分析');
                
                // 檢查PDF內容中所有可能的SpO2變體
                const spO2Variants = [
                    'SpO2', 'Sp02', 'SpO２', 'ＳｐＯ２', 'spo2', 'SPO2',
                    '血氧', '氧飽和', 'oxygen', 'saturation', 'O2 sat'
                ];
                
                const foundVariants = [];
                spO2Variants.forEach(variant => {
                    if (pdfText.includes(variant)) {
                        foundVariants.push(variant);
                    }
                });
                
                console.log('PDF中找到的SpO2變體:', foundVariants);
                
                // 提取包含SpO2相關內容的所有行
                const relevantLines = pdfText.split(/[\n\r]+/).filter(line => {
                    return spO2Variants.some(variant => 
                        line.toLowerCase().includes(variant.toLowerCase())
                    );
                });
                
                if (relevantLines.length > 0) {
                    console.log('包含SpO2的所有文字行:');
                    relevantLines.forEach((line, index) => {
                        console.log(`  ${index + 1}. "${line.trim()}"`);
                    });
                    
                    // 嘗試從這些行中提取數字
                    console.log('嘗試從相關行中提取數字:');
                    relevantLines.forEach((line, index) => {
                        const numbers = [...line.matchAll(/(\d{2,3})/g)];
                        if (numbers.length > 0) {
                            console.log(`  第${index + 1}行數字:`, numbers.map(m => m[1]).join(', '));
                        }
                    });
                } else {
                    console.log('PDF中未發現任何SpO2相關內容');
                }
                
                // 如果真的找不到，給出建議
                console.log('💡 建議: 請檢查PDF格式是否標準，或聯繫開發者添加新的匹配模式');
            }
            
            // 7. 交叉驗證和智能修正
            console.log('\n🔧 執行交叉驗證和智能修正');
            
            // 檢查是否從結論中找到更可靠的數據
            const conclusionMatch = pdfText.match(/ODI3%=(\d+).*?最低SpO2=(\d+)%.*?T90=(\d+)%/i);
            if (conclusionMatch) {
                console.log('🎯 發現結論性數據，進行交叉驗證:');
                console.log('結論ODI3%:', conclusionMatch[1]);
                console.log('結論最低SpO2:', conclusionMatch[2]);
                console.log('結論T90:', conclusionMatch[3]);
                
                // 如果結論數據與提取數據差異很大，優先使用結論數據
                const conclusionODI3 = parseInt(conclusionMatch[1]);
                const conclusionSpO2 = parseInt(conclusionMatch[2]);
                const conclusionT90 = parseInt(conclusionMatch[3]);
                
                if (result.odi3 !== null && Math.abs(result.odi3 - conclusionODI3) > 5) {
                    console.log('⚠️ ODI3%數據差異較大，使用結論數據:', conclusionODI3);
                    result.odi3 = conclusionODI3;
                }
                
                if (result.minSpo2 !== null && Math.abs(result.minSpo2 - conclusionSpO2) > 2) {
                    console.log('⚠️ SpO2數據差異較大，使用結論數據:', conclusionSpO2);
                    result.minSpo2 = conclusionSpO2;
                }
                
                if (result.t90 !== null && Math.abs(result.t90 - conclusionT90) > 3) {
                    console.log('⚠️ T90數據差異較大，使用結論數據:', conclusionT90);
                    result.t90 = conclusionT90;
                }
                
                // 如果某些數據仍然為空，使用結論數據
                if (result.odi3 === null) result.odi3 = conclusionODI3;
                if (result.minSpo2 === null) result.minSpo2 = conclusionSpO2;
                if (result.t90 === null) result.t90 = conclusionT90;
            }
            
            console.log('\n=== 智能提取完成 ===');
            console.log('最終結果:', {
                姓名: result.patientName,
                記錄時間: result.recordTime,
                列印日期: result.printDate,
                'ODI 3%': result.odi3,
                'T90時間百分比': result.t90,
                '最小SpO2': result.minSpo2
            });
            
            return result;
        }
        
        function calculateRiskFromExtractedData(data, fileName) {
            // 檢查數據完整性
            const missingData = [];
            if (data.minSpo2 === null || data.minSpo2 === undefined) missingData.push('最小SpO2');
            if (data.odi3 === null || data.odi3 === undefined) missingData.push('ODI 3%');
            if (data.t90 === null || data.t90 === undefined) missingData.push('T90');
            
            if (missingData.length === 3) {
                throw new Error('無法從PDF中提取任何關鍵數據，請檢查PDF格式或內容');
            }
            
            // 計算評分 (缺失的數據當作0分)
            const odi3Score = data.odi3 !== null && data.odi3 !== undefined ? calculateODI3Score(data.odi3) : 0;
            const spo2Score = data.minSpo2 !== null && data.minSpo2 !== undefined ? calculateSpO2Score(data.minSpo2) : 0;
            const t90Score = data.t90 !== null && data.t90 !== undefined ? calculateT90Score(data.t90) : 0;
            const totalScore = odi3Score + spo2Score + t90Score;
            
            let riskLevel;
            if (totalScore <= 3) {
                riskLevel = '低風險';
            } else if (totalScore <= 7) {
                riskLevel = '中度風險';
            } else {
                riskLevel = '高度風險';
            }
            
            // 使用提取的患者姓名，如果沒有則使用檔名
            let patientName = data.patientName || fileName.replace(/\.pdf$/i, '');
            
            return {
                fileName: fileName,
                patientName: patientName,
                recordTime: data.recordTime || '未知',
                printDate: data.printDate || '未知',
                odi3: data.odi3, // 保持原始數值
                minSpo2: data.minSpo2, // 保持原始數值
                t90: data.t90, // 保持原始數值
                odi3Score,
                spo2Score,
                t90Score,
                totalScore,
                riskLevel,
                processDate: new Date().toLocaleDateString('zh-TW'),
                missingData: missingData.length > 0 ? missingData : null
            };
        }
        
        function formatDateTime(value) {
            if (value instanceof Date) {
                return value.toLocaleString('zh-TW');
            } else if (typeof value === 'number') {
                // Excel 日期是從 1900/1/1 開始的天數
                const excelEpoch = new Date(1900, 0, 1);
                const date = new Date(excelEpoch.getTime() + (value - 2) * 24 * 60 * 60 * 1000);
                return date.toLocaleString('zh-TW');
            } else if (typeof value === 'string') {
                return value;
            }
            return '無資料';
        }
        
        function displayBatchResults() {
            const successResults = processedResults.filter(r => !r.error);
            
            // 統計摘要
            const noRisk = successResults.filter(r => r.riskLevel === '低風險').length;
            const mediumRisk = successResults.filter(r => r.riskLevel === '中度風險').length;
            const highRisk = successResults.filter(r => r.riskLevel === '高度風險').length;
            
            const summaryHTML = `
                <div class="summary-card no-risk">
                    <div class="summary-number">${noRisk}</div>
                    <div class="summary-label">低風險患者</div>
                </div>
                <div class="summary-card medium-risk">
                    <div class="summary-number">${mediumRisk}</div>
                    <div class="summary-label">中度風險患者</div>
                </div>
                <div class="summary-card high-risk">
                    <div class="summary-number">${highRisk}</div>
                    <div class="summary-label">高度風險患者</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${successResults.length}</div>
                    <div class="summary-label">總處理數量</div>
                </div>
            `;
            
            document.getElementById('resultsSummary').innerHTML = summaryHTML;
            
            // 結果表格
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>文件名稱</th>
                            <th>患者姓名</th>
                            <th>記錄時間</th>
                            <th>列印日期</th>
                            <th>ODI 3%<br/>每小時頻率</th>
                            <th>最小SpO2</th>
                            <th>T90<br/>時間百分比</th>
                            <th>總分</th>
                            <th>風險等級</th>
                            <th>備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${processedResults.map(result => {
                            if (result.error) {
                                return `
                                    <tr>
                                        <td>${result.fileName}</td>
                                        <td colspan="9" style="color: #e74c3c;">處理失敗: ${result.errorMessage}</td>
                                    </tr>
                                `;
                            }
                            
                            const riskClass = result.riskLevel === '低風險' ? 'no-risk' : 
                                            result.riskLevel === '中度風險' ? 'medium-risk' : 'high-risk';
                            
                            const noteText = result.missingData ? 
                                `缺少: ${result.missingData.join(', ')}` : '數據完整';
                            
                            // 確保顯示正確的數值格式
                            const displayOdi3 = result.odi3 !== null && result.odi3 !== undefined ? result.odi3 : '無資料';
                            const displayMinSpo2 = result.minSpo2 !== null && result.minSpo2 !== undefined ? 
                                `${result.minSpo2}%` : '無資料';
                            const displayT90 = result.t90 !== null && result.t90 !== undefined ? 
                                `${result.t90}%` : '無資料';
                            
                            return `
                                <tr>
                                    <td>${result.fileName}</td>
                                    <td>${result.patientName || '未知'}</td>
                                    <td style="font-size: 12px;">${result.recordTime || '未知'}</td>
                                    <td style="font-size: 12px;">${result.printDate || '未知'}</td>
                                    <td>${displayOdi3}</td>
                                    <td>${displayMinSpo2}</td>
                                    <td>${displayT90}</td>
                                    <td><strong>${result.totalScore}</strong></td>
                                    <td><span class="risk-badge ${riskClass}">${result.riskLevel}</span></td>
                                    <td style="font-size: 12px; color: ${result.missingData ? '#e74c3c' : '#27ae60'};">${noteText}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('resultsTable').innerHTML = tableHTML;
            document.getElementById('batchResults').style.display = 'block';
        }
        
        function calculateODI3Score(value) {
            if (value >= 25) return 6;
            if (value >= 15) return 5;
            if (value >= 10) return 4;
            if (value >= 5) return 3;
            if (value >= 3) return 2;
            if (value >= 1) return 1;
            return 0;
        }
        
        function calculateSpO2Score(value) {
            if (value < 70) return 5;
            if (value < 75) return 4;
            if (value < 80) return 3;
            if (value < 85) return 2;
            if (value < 88) return 1;
            return 0;
        }
        
        function calculateT90Score(value) {
            if (value > 15) return 4;
            if (value > 10) return 3;
            if (value > 5) return 2;
            if (value > 0) return 1;
            return 0;
        }
        
        function updateScores() {
            const odi3 = parseFloat(document.getElementById('odi3').value);
            const minSpo2 = parseFloat(document.getElementById('minSpo2').value);
            const t90 = parseFloat(document.getElementById('t90').value);
            
            // 只有當有值時才計算分數，否則顯示0
            const odi3Score = !isNaN(odi3) ? calculateODI3Score(odi3) : 0;
            const spo2Score = !isNaN(minSpo2) ? calculateSpO2Score(minSpo2) : 0;
            const t90Score = !isNaN(t90) ? calculateT90Score(t90) : 0;
            
            document.getElementById('odi3Score').textContent = odi3Score;
            document.getElementById('spo2Score').textContent = spo2Score;
            document.getElementById('t90Score').textContent = t90Score;
        }
        
        function calculateRisk() {
            // 驗證是否有輸入數值
            const odi3Value = document.getElementById('odi3').value.trim();
            const minSpo2Value = document.getElementById('minSpo2').value.trim();
            const t90Value = document.getElementById('t90').value.trim();
            
            // 檢查是否至少輸入一個數值
            if (!odi3Value && !minSpo2Value && !t90Value) {
                alert('⚠️ 請至少輸入一個檢測數值才能進行風險評估！');
                return;
            }
            
            updateScores();
            
            const odi3Score = parseInt(document.getElementById('odi3Score').textContent);
            const spo2Score = parseInt(document.getElementById('spo2Score').textContent);
            const t90Score = parseInt(document.getElementById('t90Score').textContent);
            
            const totalScore = odi3Score + spo2Score + t90Score;
            
            let riskLevel, riskColor, recommendation;
            
            if (totalScore <= 3) {
                riskLevel = '低風險';
                riskColor = '#3F7B7B';
                recommendation = '年度定期追蹤即可。維持健康生活型態，注意體重控制。若出現打鼾加重或日間嗜睡症狀，建議提前回檢。';
            } else if (totalScore <= 7) {
                riskLevel = '中度風險';
                riskColor = '#A8A093';
                recommendation = '建議3-6個月內追蹤檢查。積極進行生活型態調整：減重、戒菸、避免飲酒、採側睡姿勢。考慮安排簡易居家睡眠檢查。';
            } else {
                riskLevel = '高度風險';
                riskColor = '#D66B50';
                let urgency = '';
                if (totalScore >= 12) {
                    urgency = '極高風險 - 建議1週內轉介睡眠專科醫師。';
                } else if (totalScore >= 9) {
                    urgency = '高風險 - 建議2週內轉介睡眠專科醫師。';
                } else {
                    urgency = '中高風險 - 建議1個月內安排進一步檢查。';
                }
                recommendation = urgency + '立即安排完整睡眠檢查(PSG)，評估CPAP呼吸器治療需求，並監測心血管併發症風險。';
            }
            
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('totalScore').style.color = riskColor;
            document.getElementById('riskLevel').textContent = riskLevel;
            document.getElementById('riskLevel').style.color = riskColor;
            document.getElementById('recommendationText').textContent = recommendation;
            
            // 更新指示器位置
            const indicator = document.getElementById('scoreIndicator');
            const position = (totalScore / 14) * 100;
            indicator.style.left = position + '%';
            
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            
            // 更新匯出用的患者資訊顯示
            document.getElementById('displayPatientName').textContent = 
                document.getElementById('patientName').value || '未填寫';
            document.getElementById('displayAssessmentDate').textContent = 
                document.getElementById('assessmentDate').value || '未填寫';

        }
        
        // 添加輸入監聽器以即時更新分數
        document.getElementById('odi3').addEventListener('input', updateScores);
        document.getElementById('minSpo2').addEventListener('input', updateScores);
        document.getElementById('t90').addEventListener('input', updateScores);

        function exportToExcel() {
            if (processedResults.length === 0) {
                alert('沒有可匯出的數據！');
                return;
            }
            
            // 準備Excel數據
            const excelData = [];
            
            // 標題行
            excelData.push([
                '文件名稱',
                '患者姓名', 
                '記錄時間',
                '列印日期',
                'ODI 3% (每小時頻率)',
                '最小SpO2 (%)',
                'T90 時間百分比 (%)',
                'ODI 3% 分數',
                'SpO2 分數', 
                'T90 分數',
                '總分',
                '風險等級',
                '處理日期',
                '備註'
            ]);
            
            // 數據行
            processedResults.forEach(result => {
                if (!result.error) {
                    const noteText = result.missingData ? 
                        `缺少: ${result.missingData.join(', ')}` : '數據完整';
                        
                    excelData.push([
                        result.fileName,
                        result.patientName || '未知',
                        result.recordTime || '未知',
                        result.printDate || '未知',
                        result.odi3 !== null ? result.odi3 : '無資料',
                        result.minSpo2 !== null ? result.minSpo2 : '無資料',
                        result.t90 !== null ? result.t90 : '無資料',
                        result.odi3Score,
                        result.spo2Score,
                        result.t90Score,
                        result.totalScore,
                        result.riskLevel,
                        result.processDate,
                        noteText
                    ]);
                } else {
                    excelData.push([
                        result.fileName,
                        '處理失敗',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        result.errorMessage
                    ]);
                }
            });
            
            // 創建工作表
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // 設置列寬
            const colWidths = [
                {wch: 20}, // 文件名稱
                {wch: 12}, // 患者姓名
                {wch: 18}, // 記錄時間
                {wch: 15}, // 列印日期
                {wch: 12}, // ODI 3%
                {wch: 12}, // 最小SpO2
                {wch: 12}, // T90
                {wch: 10}, // ODI 3% 分數
                {wch: 10}, // SpO2 分數
                {wch: 10}, // T90 分數
                {wch: 8},  // 總分
                {wch: 12}, // 風險等級
                {wch: 12}, // 處理日期
                {wch: 15}  // 備註
            ];
            ws['!cols'] = colWidths;
            
            // 創建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "OSA風險評估結果");
            
            // 生成文件名
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0,8).replace(/:/g, '');
            const fileName = `OSA風險評估結果_${dateStr}_${timeStr}.xlsx`;
            
            // 下載文件
            XLSX.writeFile(wb, fileName);
        }

    </script>
</body>
</html>
