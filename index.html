<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSAé¢¨éšªè©•ä¼°é‡è¡¨</title>
    <style>
        
        /* æ‰¹é‡è™•ç†æ¨£å¼ */body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f7f7f7;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            .patient-info {
                grid-template-columns: 1fr;
            }
            
            .parameter-row {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .parameter-guide {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .batch-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .results-summary {
                grid-template-columns: 1fr;
            }
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .assessment-form {
            margin-bottom: 0;
        }
        
        .patient-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .info-group {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .info-input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .parameter-section {
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .parameter-header {
            background: #87aabd;
            color: rgb(252, 251, 251);
            padding: 15px 20px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .parameter-content {
            padding: 20px;
        }
        
        .parameter-row {
            display: grid;
            grid-template-columns: 1fr 150px 80px 100px;
            gap: 15px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .parameter-row:last-child {
            border-bottom: none;
        }
        
        .parameter-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .parameter-input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
        }
        
        .parameter-score {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #495057;
        }
        
        .calculate-btn {
            background: #FF8C73;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: block;
            margin: 30px auto;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .clear-data-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: block;
            margin: 15px auto 30px auto;
        }

        .clear-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(149, 165, 166, 0.3);
            background: #7f8c8d;
        }

        .result-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
            display: none;
        }
        
        .total-score {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .risk-level {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .recommendation {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .scale-visual {
            margin: 30px 0;
            height: 60px;
            border-radius: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .scale-segments {
            display: flex;
            height: 100%;
        }
        
        .scale-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            /* ğŸ”´ æ·»åŠ ç™½è‰²é‚Šæ¡† */
            border-right: 1px solid white;
        }

        /* ğŸ”´ æ·»åŠ ï¼šæœ€å¾Œä¸€å€‹ä¸éœ€è¦å³é‚Šæ¡† */
        .scale-segment:last-child {
            border-right: none;
        }
        
        .seg-0 { background: #4A8F8F; }   /* æ¯”åŸºæº–é»æ›´æ·±çš„ä½é¢¨éšª */
        .seg-1 { background: #4F9494; }   /* ä½é¢¨éšªéæ¸¡ */
        .seg-2 { background: #549A9A; }   /* ä½é¢¨éšªåŸºæº–é» */
        .seg-3 { background: #6FA2A2; }   /* ä½â†’ä¸­éæ¸¡ */
        .seg-4 { background: #8AABAA; }   /* ä½â†’ä¸­éæ¸¡ */
        .seg-5 { background: #A5B3B2; }   /* ä½â†’ä¸­éæ¸¡ */
        .seg-6 { background: #B6BAB1; }   /* æ¥è¿‘ä¸­é¢¨éšª */
        .seg-7 { background: #C8C0B1; }   /* ä¸­é¢¨éšªåŸºæº–é» */
        .seg-8 { background: #D0B8A8; }   /* ä¸­â†’é«˜éæ¸¡ */
        .seg-9 { background: #D8B09F; }   /* ä¸­â†’é«˜éæ¸¡ */
        .seg-10 { background: #E0A896; }  /* ä¸­â†’é«˜éæ¸¡ */
        .seg-11 { background: #E3A080; }  /* ä¸­â†’é«˜éæ¸¡ */
        .seg-12 { background: #E5846E; }  /* é«˜é¢¨éšªåŸºæº–é» */
        .seg-13 { background: #E27A64; }  /* é«˜é¢¨éšªéæ¸¡ */
        .seg-14 { background: #DF705A; }  /* æœ€é«˜é¢¨éšª */
                
        .score-indicator {
            position: absolute;
            top: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid #2c3e50;
            transform: translateX(-50%);
            transition: left 0.5s ease;
        }
        
        .scoring-guide {
            margin-top: 40px;
            padding: 25px;
            background: #e8f4fd;
            border-radius: 15px;
            border-left: 6px solid #3498db;
        }
        
        .guide-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .guide-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .guide-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
        }
        
        .guide-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #bdc3c7;
        }
        
        .guide-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .parameter-guide {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .guide-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .guide-item-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 16px;
        }
        
        .guide-item-content {
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* åˆ†é æ¨£å¼ */
        .tab-container {
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #7f8c8d;
        }
        
        .tab-button.active {
            background: #6C838F;
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #2c3e50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .batch-processing-section {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            border: 3px dashed #3498db;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section-header h3 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .section-header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .upload-area {
            background: white;
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #3498db;
        }
        
        .upload-text {
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .file-list {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #fef9e7;
            color: #f39c12;
        }
        
        .status-processing {
            background: #e3f2fd;
            color: #2196f3;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #4caf50;
        }
        
        .status-error {
            background: #ffebee;
            color: #f44336;
        }
        
        .batch-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .process-btn, .clear-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .process-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .process-btn:hover, .clear-btn:hover {
            transform: translateY(-2px);
        }
        
        .batch-results {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid;
        }
        
        .summary-card.no-risk {
            border-left-color: #27ae60;
        }
        
        .summary-card.medium-risk {
            border-left-color: #f39c12;
        }
        
        .summary-card.high-risk {
            border-left-color: #e74c3c;
        }
        
        .summary-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .results-table {
            overflow-x: auto;
        }
        
        .results-table table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .results-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .results-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #bdc3c7;
            font-size: 14px;
        }
        
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .risk-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .risk-badge.no-risk {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .risk-badge.medium-risk {
            background: #fef9e7;
            color: #f39c12;
        }
        
        .risk-badge.high-risk {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .divider {
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            color: #7f8c8d;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #bdc3c7, transparent);
        }
        
        .divider span {
            background: white;
            padding: 0 20px;
        }

        .export-excel-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .export-excel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(46, 204, 113, 0.3);
        }

        .progress-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-info span:first-child {
            color: #2c3e50;
            font-size: 16px;
        }

        .progress-info span:last-child {
            color: #3498db;
            font-size: 18px;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255,255,255,0.2) 50%, 
                rgba(255,255,255,0.2) 75%, 
                transparent 75%, 
                transparent);
            background-size: 20px 20px;
            animation: progress-stripes 1s linear infinite;
        }

        @keyframes progress-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .progress-details {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
            line-height: 1.4;
        }

        .progress-details .current-file {
            color: #2c3e50;
            font-weight: bold;
        }

        .file-scroll-container {
            max-height: 400px; /* å¤§ç´„å¯é¡¯ç¤º10å€‹æ–‡ä»¶é …ç›®çš„é«˜åº¦ */
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 5px;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        .file-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .file-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .file-scroll-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .file-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        /* æ»¾å‹•æç¤º */
        .file-scroll-container::after {
            content: '';
            display: block;
            height: 1px;
        }

        /* ç•¶æ–‡ä»¶è¶…éå®¹å™¨é«˜åº¦æ™‚é¡¯ç¤ºæ¼¸è®Šæ•ˆæœ */
        .file-scroll-container.has-scroll {
            position: relative;
        }

        .file-scroll-container.has-scroll::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 8px; /* é¿å…è¦†è“‹æ»¾å‹•æ¢ */
            height: 20px;
            background: linear-gradient(transparent, rgba(248, 249, 250, 0.8));
            pointer-events: none;
            z-index: 1;
        }

        /* å„ªåŒ–æ–‡ä»¶é …ç›®åœ¨æ»¾å‹•å®¹å™¨ä¸­çš„é¡¯ç¤º */
        .file-scroll-container .file-item {
            margin: 5px;
            background: white;
        }

        .file-scroll-container .file-item:hover {
            transform: none; /* åœ¨æ»¾å‹•å®¹å™¨ä¸­ä¸è¦æœ‰éå¤šçš„å‹•ç•«æ•ˆæœ */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .export-image-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: block;
            margin: 15px auto;
        }

        .export-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">OSAé¢¨éšªè©•ä¼°é‡è¡¨</div>
            <div class="subtitle">é˜»å¡æ€§ç¡çœ å‘¼å¸ä¸­æ­¢ç—‡ç¯©æª¢å·¥å…·</div>
        </div>
        
        <div class="content">
            <!-- åˆ†é å®¹å™¨ -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('single')">
                        ğŸ¥ å–®ä¸€æª¢æ¸¬
                    </button>
                    <button class="tab-button" onclick="switchTab('batch')">
                        ğŸ“„ æ‰¹é‡åˆ†æ
                    </button>
                </div>
                
                <!-- å–®ä¸€æª¢æ¸¬åˆ†é  -->
                <div id="singleTab" class="tab-content active">
                    <div class="assessment-form">
                        <div class="patient-info">
                            <div class="info-group">
                                <label class="info-label">å§“åï¼š</label>
                                <input type="text" class="info-input" id="patientName" placeholder="è«‹è¼¸å…¥å§“å">
                            </div>
                            <div class="info-group">
                                <label class="info-label">æª¢æŸ¥æ—¥æœŸï¼š</label>
                                <input type="date" class="info-input" id="assessmentDate">
                            </div>
                        </div>
                        
                        <div class="parameter-section">
                            <div class="parameter-header">ODI 3% (æ°§æ°£ä¸é£½å’ŒæŒ‡æ•¸)</div>
                            <div class="parameter-content">
                                <div class="parameter-row">
                                    <div class="parameter-label">ODI 3% æ•¸å€¼</div>
                                    <input type="number" class="parameter-input" id="odi3" placeholder="è¼¸å…¥æ•¸å€¼" min="0" max="100">
                                    <div class="parameter-score" id="odi3Score">0</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">æœ€é‡è¦æŒ‡æ¨™</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="parameter-section">
                            <div class="parameter-header">æœ€å°è¡€æ°§é£½å’Œåº¦ (SpO2)</div>
                            <div class="parameter-content">
                                <div class="parameter-row">
                                    <div class="parameter-label">æœ€å° SpO2 (%)</div>
                                    <input type="number" class="parameter-input" id="minSpo2" placeholder="è¼¸å…¥ç™¾åˆ†æ¯”" min="0" max="100">
                                    <div class="parameter-score" id="spo2Score">0</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">æ¬¡é‡è¦æŒ‡æ¨™</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="parameter-section">
                            <div class="parameter-header">T90 (è¡€æ°§<90%æ™‚é–“æ¯”ä¾‹)</div>
                            <div class="parameter-content">
                                <div class="parameter-row">
                                    <div class="parameter-label">T90 (%)</div>
                                    <input type="number" class="parameter-input" id="t90" placeholder="è¼¸å…¥ç™¾åˆ†æ¯”" min="0" max="100">
                                    <div class="parameter-score" id="t90Score">0</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">è¼”åŠ©æŒ‡æ¨™</div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="calculate-btn" onclick="calculateRisk()">è¨ˆç®—é¢¨éšªç­‰ç´š</button>
                        <button class="clear-data-btn" onclick="clearSingleAssessmentData()">ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š</button>
                    </div>
                    
                    <div class="result-section" id="resultSection">
                        <div id="patientInfoForExport" style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 10px; font-size: 14px;">
                            <strong>æ‚£è€…ï¼š</strong><span id="displayPatientName">-</span> | 
                            <strong>æª¢æŸ¥æ—¥æœŸï¼š</strong><span id="displayAssessmentDate">-</span>
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">è©•ä¼°çµæœ</h3>
                        <div class="total-score" id="totalScore">0</div>
                        <div style="font-size: 16px; color: #7f8c8d; margin-bottom: 15px;">ç¸½åˆ†</div>
                        
                        <div class="scale-visual">
                            <div class="scale-segments">
                                <div class="scale-segment seg-0">0</div>
                                <div class="scale-segment seg-1">1</div>
                                <div class="scale-segment seg-2">2</div>
                                <div class="scale-segment seg-3">3</div>
                                <div class="scale-segment seg-4">4</div>
                                <div class="scale-segment seg-5">5</div>
                                <div class="scale-segment seg-6">6</div>
                                <div class="scale-segment seg-7">7</div>
                                <div class="scale-segment seg-8">8</div>
                                <div class="scale-segment seg-9">9</div>
                                <div class="scale-segment seg-10">10</div>
                                <div class="scale-segment seg-11">11</div>
                                <div class="scale-segment seg-12">12</div>
                                <div class="scale-segment seg-13">13</div>
                                <div class="scale-segment seg-14">14</div>
                            </div>
                            <div class="score-indicator" id="scoreIndicator"></div>
                        </div>
                        
                        <div class="risk-level" id="riskLevel">-</div>
                        <div class="recommendation" id="recommendation">
                            <h4 style="margin-top: 0; color: #2c3e50;">å»ºè­°è™•ç½®</h4>
                            <p id="recommendationText">è«‹å…ˆé€²è¡Œè©•ä¼°</p>
                        </div>
                        <button class="export-image-btn" onclick="exportResultAsImage()">ğŸ“· åŒ¯å‡ºçµæœåœ–ç‰‡</button>
                    </div>
                </div>
                
                <!-- æ‰¹é‡åˆ†æåˆ†é  -->
                <div id="batchTab" class="tab-content">
                    <div class="batch-processing-section">
                        <div class="section-header">
                            <h3>ğŸ“„ æ™ºèƒ½æ‰¹é‡PDFåˆ†æ</h3>
                            <p>ç›´æ¥åˆ†æOSAæª¢æ¸¬å ±å‘ŠPDFï¼Œæ™ºèƒ½æå–é—œéµæ•¸æ“šä¸¦è¨ˆç®—é¢¨éšªç­‰ç´š</p>
                        </div>
                        
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <div class="upload-icon">ğŸ“„</div>
                                <div class="upload-text">
                                    <strong>æ‹–æ›³PDFæ–‡ä»¶åˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡</strong><br>
                                    <span>æ”¯æ´å¤šæª”æ¡ˆåŒæ™‚ä¸Šå‚³</span><br>
                                    <small style="color: #7f8c8d;">ç³»çµ±æœƒè‡ªå‹•è½‰æ›PDFç‚ºExcelä¸¦è®€å–æ•¸æ“š</small>
                                </div>
                                <input type="file" id="pdfFiles" multiple accept=".pdf" style="display: none;">
                                <button class="upload-btn" onclick="document.getElementById('pdfFiles').click()">é¸æ“‡PDFæ–‡ä»¶</button>
                            </div>
                        </div>
                        
                        <div class="file-list" id="fileList" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">å·²ä¸Šå‚³çš„æ–‡ä»¶ï¼š</h4>
                                <span id="fileCount" style="color: #7f8c8d; font-size: 14px;"></span>
                            </div>
                            <div class="file-scroll-container">
                                <div id="uploadedFiles"></div>
                            </div>
                            <div class="batch-actions">
                                <button class="process-btn" onclick="processPDFs()">ğŸ” é–‹å§‹åˆ†æ</button>
                                <button class="clear-btn" onclick="clearFiles()">ğŸ—‘ï¸æ¸…ç©ºæ–‡ä»¶</button>
                            </div>
                            
                            <!-- æ·»åŠ é€²åº¦æ¢ -->
                            <div class="progress-container" id="progressContainer" style="display: none;">
                                <div class="progress-info">
                                    <span id="progressText">æº–å‚™ä¸­...</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-details" id="progressDetails"></div>
                            </div>
                        </div>
                        
                        <div class="batch-results" id="batchResults" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="margin: 0;">åˆ†æçµæœï¼š</h4>
                                <button class="export-excel-btn" onclick="exportToExcel()">ğŸ“Š åŒ¯å‡ºExcel</button>
                            </div>
                            <div class="results-summary" id="resultsSummary"></div>
                            <div class="results-table" id="resultsTable"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="scoring-guide">
                <div class="guide-title">ğŸ“‹ è©•åˆ†æ¨™æº–èªªæ˜</div>
                
                <div class="parameter-guide">
                    <div class="guide-item">
                        <div class="guide-item-title">ğŸ”´ ODI 3% è©•åˆ†</div>
                        <div class="guide-item-content">
                            <strong>â‰¥25ï¼š</strong> 6åˆ†<br>
                            <strong>15-24ï¼š</strong> 5åˆ†<br>
                            <strong>10-14ï¼š</strong> 4åˆ†<br>
                            <strong>5-9ï¼š</strong> 3åˆ†<br>
                            <strong>3-4ï¼š</strong> 2åˆ†<br>
                            <strong>1-2ï¼š</strong> 1åˆ†<br>
                            <strong>0ï¼š</strong> 0åˆ†
                        </div>
                    </div>
                    
                    <div class="guide-item">
                        <div class="guide-item-title">ğŸŸ  æœ€å°SpO2è©•åˆ†</div>
                        <div class="guide-item-content">
                            <strong>&lt;70%ï¼š</strong> 5åˆ†<br>
                            <strong>70-74%ï¼š</strong> 4åˆ†<br>
                            <strong>75-79%ï¼š</strong> 3åˆ†<br>
                            <strong>80-84%ï¼š</strong> 2åˆ†<br>
                            <strong>85-87%ï¼š</strong> 1åˆ†<br>
                            <strong>â‰¥88%ï¼š</strong> 0åˆ†
                        </div>
                    </div>
                    
                    <div class="guide-item">
                        <div class="guide-item-title">ğŸŸ¡ T90 è©•åˆ†</div>
                        <div class="guide-item-content">
                            <strong>&gt;15%ï¼š</strong> 4åˆ†<br>
                            <strong>11-15%ï¼š</strong> 3åˆ†<br>
                            <strong>6-10%ï¼š</strong> 2åˆ†<br>
                            <strong>1-5%ï¼š</strong> 1åˆ†<br>
                            <strong>0%ï¼š</strong> 0åˆ†
                        </div>
                    </div>
                </div>
                
                <table class="guide-table">
                    <thead>
                        <tr>
                            <th>é¢¨éšªç­‰ç´š</th>
                            <th>ç¸½åˆ†ç¯„åœ</th>
                            <th>å»ºè­°è™•ç½®</th>
                            <th>è¿½è¹¤é »ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #d5f4e6;">
                            <td><strong>ä½é¢¨éšª</strong></td>
                            <td>0-3åˆ†</td>
                            <td>å¹´åº¦å®šæœŸè¿½è¹¤</td>
                            <td>12å€‹æœˆ</td>
                        </tr>
                        <tr style="background: #fef9e7;">
                            <td><strong>ä¸­åº¦é¢¨éšª</strong></td>
                            <td>4-7åˆ†</td>
                            <td>ç”Ÿæ´»å‹æ…‹èª¿æ•´</td>
                            <td>3-6å€‹æœˆ</td>
                        </tr>
                        <tr style="background: #fadbd8;">
                            <td><strong>é«˜åº¦é¢¨éšª</strong></td>
                            <td>8-14åˆ†</td>
                            <td>ç«‹å³è½‰ä»‹å°ˆç§‘</td>
                            <td>ä¾é†«å¸«æŒ‡ç¤º</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // è¼‰å…¥PDF.jsåº«
        const pdfScript = document.createElement('script');
        pdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        document.head.appendChild(pdfScript);
        
        // è¼‰å…¥html2canvasåº«
        function loadHtml2Canvas() {
            if (typeof html2canvas === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = function() {
                    console.log('html2canvas åº«è¼‰å…¥å®Œæˆ');
                };
                document.head.appendChild(script);
            }
        }

        // é é¢è¼‰å…¥æ™‚è¼‰å…¥åº«
        loadHtml2Canvas();

        // è¼‰å…¥SheetJSåº«ç”¨æ–¼ExcelåŒ¯å‡º
        const xlsxScript = document.createElement('script');
        xlsxScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        document.head.appendChild(xlsxScript);

        // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
        document.getElementById('assessmentDate').valueAsDate = new Date();
        
        // æ¸…ç©ºå–®ä¸€æª¢æ¸¬æ•¸æ“šçš„å‡½æ•¸
        function clearSingleAssessmentData() {
            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            document.getElementById('patientName').value = '';
            document.getElementById('odi3').value = '';
            document.getElementById('minSpo2').value = '';
            document.getElementById('t90').value = '';
            
            // é‡ç½®åˆ†æ•¸é¡¯ç¤º
            document.getElementById('odi3Score').textContent = '0';
            document.getElementById('spo2Score').textContent = '0';
            document.getElementById('t90Score').textContent = '0';
            
            // éš±è—çµæœå€åŸŸ
            document.getElementById('resultSection').style.display = 'none';
            
            // é‡è¨­æª¢æŸ¥æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('assessmentDate').valueAsDate = new Date();
        }

        // åˆ†é åˆ‡æ›åŠŸèƒ½
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„åˆ†é 
            if (tabName === 'single') {
                document.getElementById('singleTab').classList.add('active');
                document.querySelector('.tab-button:first-child').classList.add('active');
                
                // æ¸…ç©ºå–®ä¸€æª¢æ¸¬çš„æ•¸æ“š
                clearSingleAssessmentData();
                
            } else if (tabName === 'batch') {
                document.getElementById('batchTab').classList.add('active');
                document.querySelector('.tab-button:last-child').classList.add('active');
            }
        }
        
        // æ‰¹é‡è™•ç†ç›¸é—œè®Šæ•¸
        let uploadedFiles = [];
        let processedResults = [];
        
        // æ‹–æ›³ä¸Šå‚³åŠŸèƒ½
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('pdfFiles');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            handleFileUpload(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileUpload(files);
        });
        
        async function exportResultAsImage() {
            const resultElement = document.getElementById('resultSection');
            
            if (!resultElement || resultElement.style.display === 'none') {
                alert('è«‹å…ˆé€²è¡Œé¢¨éšªè©•ä¼°ï¼');
                return;
            }
            
            try {
                // ç­‰å¾…html2canvasåº«è¼‰å…¥
                if (typeof html2canvas === 'undefined') {
                    alert('åœ–ç‰‡åŒ¯å‡ºåŠŸèƒ½æ­£åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦...');
                    return;
                }
                
                // ç²å–æ‚£è€…è³‡è¨Š
                const patientName = document.getElementById('patientName').value || 'æœªçŸ¥æ‚£è€…';
                const assessmentDate = document.getElementById('assessmentDate').value || 'æœªçŸ¥æ—¥æœŸ';
                
                // æˆªåœ–é¸é …
                const options = {
                    backgroundColor: '#ffffff',
                    scale: 2, // é«˜è§£æåº¦
                    useCORS: true,
                    allowTaint: true,
                    width: resultElement.offsetWidth,
                    height: resultElement.offsetHeight
                };
                
                // ç”Ÿæˆæˆªåœ–
                const canvas = await html2canvas(resultElement, options);
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const link = document.createElement('a');
                link.download = `OSAé¢¨éšªè©•ä¼°çµæœ_${patientName}_${assessmentDate}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // è§¸ç™¼ä¸‹è¼‰
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('åŒ¯å‡ºåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—ï¼Œè«‹é‡è©¦ï¼');
            }
        }

        function handleFileUpload(files) {
            uploadedFiles = [...uploadedFiles, ...files];
            displayUploadedFiles();
            document.getElementById('fileList').style.display = 'block';
        }
        
        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            const scrollContainer = container.parentElement;
            const fileCountSpan = document.getElementById('fileCount');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ›´æ–°æ–‡ä»¶æ•¸é‡é¡¯ç¤º
            fileCountSpan.textContent = `å…± ${uploadedFiles.length} å€‹æ–‡ä»¶`;
            
            // å‰µå»ºæ‰€æœ‰æ–‡ä»¶é …ç›®
            uploadedFiles.forEach((file, index) => {
                const fileItem = createFileItem(file, index);
                container.appendChild(fileItem);
            });
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ»¾å‹•ï¼Œæ·»åŠ æ¼¸è®Šæ•ˆæœ
            setTimeout(() => {
                if (container.scrollHeight > scrollContainer.clientHeight) {
                    scrollContainer.classList.add('has-scroll');
                } else {
                    scrollContainer.classList.remove('has-scroll');
                }
            }, 100);
        }

        function createFileItem(file, index) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <span>ğŸ“„</span>
                    <span>${file.name}</span>
                    <span class="file-size">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                </div>
                <div>
                    <span class="file-status status-pending" id="status-${index}">ç­‰å¾…è™•ç†</span>
                    <button onclick="removeFile(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer;">âœ•</button>
                </div>
            `;
            return fileItem;
        }

        function createFileItem(file, index) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <span>ğŸ“„</span>
                    <span>${file.name}</span>
                    <span class="file-size">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                </div>
                <div>
                    <span class="file-status status-pending" id="status-${index}">ç­‰å¾…è™•ç†</span>
                    <button onclick="removeFile(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer;">âœ•</button>
                </div>
            `;
            return fileItem;
        }
        
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayUploadedFiles();
            if (uploadedFiles.length === 0) {
                document.getElementById('fileList').style.display = 'none';
            }
        }
        
        function clearFiles() {
            uploadedFiles = [];
            processedResults = [];
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('batchResults').style.display = 'none';
        }
        
        async function processPDFs() {
            if (uploadedFiles.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³PDFæ–‡ä»¶');
                return;
            }
            
            // é¡¯ç¤ºé€²åº¦æ¢
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');
            
            // åˆå§‹åŒ–é€²åº¦æ¢
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressText.textContent = 'æº–å‚™é–‹å§‹åˆ†æ...';
            progressDetails.innerHTML = `æº–å‚™è™•ç† ${uploadedFiles.length} å€‹PDFæ–‡ä»¶`;
            
            // æ¸…ç©ºä¹‹å‰çš„çµæœ
            processedResults = [];
            
            const totalFiles = uploadedFiles.length;
            let completedFiles = 0;
            
            for (let i = 0; i < totalFiles; i++) {
                const currentFile = uploadedFiles[i];
                const statusElement = document.getElementById(`status-${i}`);
                
                // æ›´æ–°ç•¶å‰æ–‡ä»¶ä¿¡æ¯
                progressText.textContent = `æ­£åœ¨åˆ†æ: ${currentFile.name}`;
                progressDetails.innerHTML = `
                    <div class="current-file">ç•¶å‰: ${currentFile.name}</div>
                    <div>é€²åº¦: ${completedFiles} / ${totalFiles} å€‹æ–‡ä»¶å·²å®Œæˆ</div>
                `;
                
                // æ›´æ–°ç‹€æ…‹ç‚ºè™•ç†ä¸­
                statusElement.textContent = 'åˆ†æä¸­...';
                statusElement.className = 'file-status status-processing';
                
                try {
                    // è™•ç†PDF
                    const result = await processPDF(currentFile, statusElement);
                    processedResults.push(result);
                    
                    // æˆåŠŸè™•ç†
                    statusElement.textContent = 'âœ… å®Œæˆ';
                    statusElement.className = 'file-status status-success';
                    
                } catch (error) {
                    console.error('è™•ç†PDFæ™‚å‡ºéŒ¯:', error);
                    
                    // è™•ç†å¤±æ•—
                    statusElement.textContent = 'âŒ å¤±æ•—';
                    statusElement.className = 'file-status status-error';
                    
                    processedResults.push({
                        fileName: currentFile.name,
                        error: true,
                        errorMessage: error.message
                    });
                }
                
                // æ›´æ–°å®Œæˆæ•¸é‡å’Œé€²åº¦æ¢
                completedFiles++;
                const progress = Math.round((completedFiles / totalFiles) * 100);
                progressFill.style.width = progress + '%';
                progressPercent.textContent = progress + '%';
                
            }
            
            // æ‰€æœ‰æ–‡ä»¶è™•ç†å®Œæˆ
            const successCount = processedResults.filter(r => !r.error).length;
            const errorCount = processedResults.filter(r => r.error).length;
            
            progressText.textContent = 'ğŸ‰ åˆ†æå®Œæˆï¼';
            progressDetails.innerHTML = `
                <div style="color: #27ae60;">âœ… æˆåŠŸ: ${successCount} å€‹æ–‡ä»¶</div>
                ${errorCount > 0 ? `<div style="color: #e74c3c;">âŒ å¤±æ•—: ${errorCount} å€‹æ–‡ä»¶</div>` : ''}
                <div>ç¸½è¨ˆè™•ç†: ${totalFiles} å€‹æ–‡ä»¶</div>
            `;
            
            // é¡¯ç¤ºçµæœ
            displayBatchResults();
            
            // 3ç§’å¾Œéš±è—é€²åº¦æ¢
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
        }
        
        async function processPDF(file, statusElement) {
            return new Promise(async (resolve, reject) => {
                try {
                    // ç¬¬ä¸€æ­¥ï¼šè®€å–ä¸¦è§£æPDF
                    statusElement.textContent = 'ğŸ“– è®€å–PDF...';
                    const pdfData = await readPDFFile(file);
                    
                    // ç¬¬äºŒæ­¥ï¼šæå–é—œéµæ•¸æ“š
                    statusElement.textContent = 'ğŸ” æå–æ•¸æ“š...';
                    const extractedData = extractDataFromPDFText(pdfData.text, file.name);
                    
                    // ç¬¬ä¸‰æ­¥ï¼šè¨ˆç®—é¢¨éšªç­‰ç´š
                    statusElement.textContent = 'âš–ï¸ è¨ˆç®—é¢¨éšª...';
                    const result = calculateRiskFromExtractedData(extractedData, file.name);
                    
                    resolve(result);
                    
                } catch (error) {
                    reject(new Error(`PDFåˆ†æå¤±æ•—: ${error.message}`));
                }
            });
        }
        
        async function readPDFFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        // ç­‰å¾…PDF.jsåº«è¼‰å…¥
                        if (typeof pdfjsLib === 'undefined') {
                            // å¦‚æœPDF.jsé‚„æ²’è¼‰å…¥ï¼Œç­‰å¾…ä¸€ä¸‹
                            setTimeout(() => readPDFFile(file).then(resolve).catch(reject), 1000);
                            return;
                        }
                        
                        const typedArray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        
                        let fullText = '';
                        let pageTexts = []; // å„²å­˜æ¯é çš„æ–‡å­—
                        
                        // è®€å–æ‰€æœ‰é é¢çš„æ–‡å­—å…§å®¹
                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();
                            
                            // æ›´ä»”ç´°åœ°çµ„åˆæ–‡å­—ï¼Œä¿ç•™æ›´å¤šç©ºæ ¼å’Œçµæ§‹
                            let pageText = '';
                            textContent.items.forEach((item, index) => {
                                // æ·»åŠ ç©ºæ ¼ä¾†åˆ†éš”æ–‡å­—é …ç›®
                                if (index > 0) {
                                    pageText += ' ';
                                }
                                pageText += item.str;
                            });
                            
                            pageTexts.push(pageText);
                            fullText += `\n=== ç¬¬${pageNum}é  ===\n${pageText}\n`;
                        }
                        
                        console.log('=== PDFè®€å–è©³æƒ… ===');
                        console.log('ç¸½é æ•¸:', pdf.numPages);
                        console.log('å„é æ–‡å­—é•·åº¦:', pageTexts.map((text, i) => `ç¬¬${i+1}é : ${text.length}å­—`));
                        
                        // é¡¯ç¤ºæ¯é çš„é–‹é ­éƒ¨åˆ†
                        pageTexts.forEach((text, i) => {
                            console.log(`ç¬¬${i+1}é å‰200å­—:`, text.substring(0, 200));
                        });
                        
                        resolve({
                            text: fullText,
                            pageTexts: pageTexts,
                            numPages: pdf.numPages
                        });
                        
                    } catch (error) {
                        console.error('PDFè§£æéŒ¯èª¤:', error);
                        reject(new Error(`PDFè§£æå¤±æ•—: ${error.message}`));
                    }
                };
                reader.onerror = function() {
                    reject(new Error('PDFæª”æ¡ˆè®€å–å¤±æ•—'));
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function convertPDFToExcel(pdfData, fileName) {
            return new Promise((resolve, reject) => {
                try {
                    // å¾PDFæ–‡å­—ä¸­æå–é—œéµæ•¸æ“š
                    const extractedData = extractDataFromPDFText(pdfData.text, fileName);
                    resolve(extractedData);
                } catch (error) {
                    reject(new Error(`æ•¸æ“šæå–å¤±æ•—: ${error.message}`));
                }
            });
        }
        
        function extractDataFromPDFText(pdfText, fileName) {
            console.log('=== é–‹å§‹PDFæ•¸æ“šæå– (Soosynæ ¼å¼ - æ™ºèƒ½å„ªå…ˆç´šç‰ˆæœ¬) ===');
            console.log('æª”æ¡ˆåç¨±:', fileName);
            console.log('PDFå…§å®¹é è¦½:', pdfText.substring(0, 300));
            
            const result = {
                patientName: null,
                recordTime: null,
                printDate: null,
                odi3: null,
                minSpo2: null,
                t90: null
            };
            
            // 1. æå–æ‚£è€…å§“å - "å§“å : å³æ–‡å½¬"
            const namePatterns = [
                /å§“å\s*[:ï¼š]\s*([^\s\n\rç—…æ­·è™Ÿ]+)/i,
                /å§“å.*?[:ï¼š]\s*([^\s\n\r]+)/i
            ];
            
            for (const pattern of namePatterns) {
                const match = pdfText.match(pattern);
                if (match && !result.patientName) {
                    let name = match[1].trim();
                    // æ¸…ç†å§“åä¸­çš„å¤šé¤˜æ–‡å­—
                    name = name.replace(/èº«é«˜.*|ç—….*|çº–ç¶­.*|å·¥å» .*|-.*/, '').trim();
                    if (name.length > 0 && name.length <= 10) {
                        result.patientName = name;
                        console.log('âœ… æ‰¾åˆ°å§“å:', result.patientName);
                        break;
                    }
                }
            }
            
            // 2. æå–è¨˜éŒ„æ™‚é–“ - "è¨˜éŒ„æ™‚é–“ : 2025/4/1 22:31 - 2025/4/2 6:13"
            const recordTimePatterns = [
                /è¨˜éŒ„æ™‚é–“\s*[:ï¼š]\s*([0-9/:\s-]+)/i,
                /è¨˜éŒ„æ™‚é–“.*?[:ï¼š]\s*([0-9/:\s-]+)/i
            ];
            
            for (const pattern of recordTimePatterns) {
                const match = pdfText.match(pattern);
                if (match && !result.recordTime) {
                    result.recordTime = match[1].trim();
                    console.log('âœ… æ‰¾åˆ°è¨˜éŒ„æ™‚é–“:', result.recordTime);
                    break;
                }
            }
            
            // 3. æå–åˆ—å°æ—¥æœŸ - "åˆ—å°æ—¥æœŸ : 2025å¹´04æœˆ21æ—¥"
            const printDatePatterns = [
                /åˆ—å°æ—¥æœŸ\s*[:ï¼š]\s*([0-9å¹´æœˆæ—¥]+)/i,
                /åˆ—å°æ—¥æœŸ.*?[:ï¼š]\s*([0-9å¹´æœˆæ—¥]+)/i
            ];
            
            for (const pattern of printDatePatterns) {
                const match = pdfText.match(pattern);
                if (match && !result.printDate) {
                    result.printDate = match[1].trim();
                    console.log('âœ… æ‰¾åˆ°åˆ—å°æ—¥æœŸ:', result.printDate);
                    break;
                }
            }
            
            // 4. æ™ºèƒ½æå–ODI 3% - æŒ‰å„ªå…ˆç´šé †åºæå–
            console.log('\nğŸ” æ™ºèƒ½æå–ODI 3% (æŒ‰å„ªå…ˆç´š)');
            
            // å„ªå…ˆç´š1: çµè«–æ€§è©•ä¼°æ•¸æ“š (æœ€é«˜å„ªå…ˆç´š)
            const odi3ConclusionPatterns = [
                /ODI3%=(\d+)/i,
                /ODI\s*3%\s*=\s*(\d+)/i
            ];
            
            for (const pattern of odi3ConclusionPatterns) {
                const match = pdfText.match(pattern);
                if (match) {
                    result.odi3 = parseInt(match[1]);
                    console.log('âœ… [å„ªå…ˆç´š1] å¾çµè«–æå–ODI 3%:', result.odi3, '- ä¾†æº:', match[0]);
                    break;
                }
            }
            
            // å„ªå…ˆç´š2: è¡¨æ ¼ä¸»è¦æ•¸æ“š (å¦‚æœæ²’æ‰¾åˆ°çµè«–æ•¸æ“š)
            if (result.odi3 === null) {
                const odi3TablePatterns = [
                    /ODI\s*3%\s+(\d+)\s*æ¬¡.*?\d+\s*æ¬¡\s*æ¯å°æ™‚/i,
                    /ODI\s*3%\s+(\d+)\s*æ¬¡/i
                ];
                
                for (const pattern of odi3TablePatterns) {
                    const match = pdfText.match(pattern);
                    if (match) {
                        const value = parseInt(match[1]);
                        if (value >= 0 && value <= 200) {
                            result.odi3 = value;
                            console.log('âœ… [å„ªå…ˆç´š2] å¾è¡¨æ ¼æå–ODI 3%:', result.odi3, '- ä¾†æº:', match[0]);
                            break;
                        }
                    }
                }
            }
            
            // å„ªå…ˆç´š3: é »ç‡æ•¸æ“š (æœ€å¾Œé¸æ“‡)
            if (result.odi3 === null) {
                const odi3FrequencyPatterns = [
                    /æ¯å°æ™‚\s*ODI\s*3%\s*é »ç‡\s+([0-9]+\.?[0-9]*)/i,
                    /æ¯å°æ™‚.*?ODI.*?3%.*?(\d+\.?\d*)/i
                ];
                
                for (const pattern of odi3FrequencyPatterns) {
                    const match = pdfText.match(pattern);
                    if (match) {
                        const value = parseFloat(match[1]);
                        if (value >= 0 && value <= 200) {
                            result.odi3 = value;
                            console.log('âš ï¸ [å„ªå…ˆç´š3] å¾é »ç‡æå–ODI 3%:', result.odi3, '- ä¾†æº:', match[0]);
                            console.log('æ³¨æ„ï¼šé€™å¯èƒ½ä¸æ˜¯ç”¨æ–¼é¢¨éšªè©•ä¼°çš„æ­£ç¢ºæ•¸å€¼');
                            break;
                        }
                    }
                }
            }
            
            // 5. æå–T90 - å°‡"T90 (SpO2 < 90%)"è¦–ç‚ºé—œéµè©ï¼Œæå–å¾Œé¢ç¬¬ä¸€å€‹å„²å­˜æ ¼æ•¸å€¼
            console.log('\nğŸ” æå–T90 - é—œéµè©åŒ¹é…æ¨¡å¼');
            
            // å„ªå…ˆç´š1: å¾çµè«–æå–
            const t90ConclusionMatch = pdfText.match(/T90=(\d+)%/i);
            if (t90ConclusionMatch) {
                result.t90 = parseInt(t90ConclusionMatch[1]);
                console.log('âœ… [å„ªå…ˆç´š1] å¾çµè«–æå–T90:', result.t90, '- ä¾†æº:', t90ConclusionMatch[0]);
            }
            
            // å„ªå…ˆç´š2: é—œéµè©åŒ¹é… - "T90 (SpO2 < 90%)" å¾Œé¢ç¬¬ä¸€å€‹æ•¸å€¼
            if (result.t90 === null) {
                console.log('ğŸ” ä½¿ç”¨é—œéµè©åŒ¹é…: "T90 (SpO2 < 90%)" + ç¬¬ä¸€å€‹æ•¸å€¼');
                
                // å°‡"T90 (SpO2 < 90%)"è¦–ç‚ºå›ºå®šé—œéµè©ï¼Œæå–å¾Œé¢ç¬¬ä¸€å€‹æ•¸å­—
                const t90KeywordMatch = pdfText.match(/T90\s*\(\s*SpO2\s*<\s*90%\s*\)\s+(\d+)/i);
                
                if (t90KeywordMatch) {
                    const firstNumber = parseInt(t90KeywordMatch[1]);
                    console.log('é—œéµè©åŒ¹é…çµæœ:', t90KeywordMatch[0]);
                    console.log('ç¬¬ä¸€å€‹æ•¸å€¼:', firstNumber);
                    
                    // ç›´æ¥æ¡ç”¨ç¬¬ä¸€å€‹æ•¸å€¼ï¼Œä½†æª¢æŸ¥åˆç†æ€§
                    if (firstNumber >= 0 && firstNumber <= 100) {
                        result.t90 = firstNumber;
                        console.log('âœ… [å„ªå…ˆç´š2] é—œéµè©åŒ¹é…T90:', result.t90, '%');
                    } else {
                        console.log('âš ï¸ ç¬¬ä¸€å€‹æ•¸å€¼è¶…å‡ºåˆç†ç¯„åœ(0-100):', firstNumber);
                    }
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°T90é—œéµè©åŒ¹é…');
                }
            }
            
            // å„ªå…ˆç´š3: å‚™ç”¨æ¨¡å¼
            if (result.t90 === null) {
                console.log('ğŸ”„ ä½¿ç”¨å‚™ç”¨æ¨¡å¼æå–T90');
                const t90BackupPatterns = [
                    /T90.*?(\d+)\s*%/i,
                    /T90.*?(\d+)/i
                ];
                
                for (const pattern of t90BackupPatterns) {
                    const match = pdfText.match(pattern);
                    if (match) {
                        const val = parseInt(match[1]);
                        if (val >= 0 && val <= 100) {
                            result.t90 = val;
                            console.log('âœ… [å‚™ç”¨æ¨¡å¼] æå–T90:', result.t90, '- ä¾†æº:', match[0]);
                            break;
                        }
                    }
                }
            }
            
            // 6. æå–æœ€å°SpO2 - è¶…å¼·å¤šé‡æ¨¡å¼åŒ¹é…ï¼Œè™•ç†å„ç¨®è¤‡é›œæ ¼å¼
            console.log('\nğŸ” æå–æœ€å°SpO2 - è¶…å¼·å¤šé‡æ¨¡å¼åŒ¹é…');
            
            // å„ªå…ˆç´š1: å¾çµè«–æå–
            const spo2ConclusionMatch = pdfText.match(/æœ€ä½SpO2=(\d+)%/i);
            if (spo2ConclusionMatch) {
                result.minSpo2 = parseInt(spo2ConclusionMatch[1]);
                console.log('âœ… [å„ªå…ˆç´š1] å¾çµè«–æå–SpO2:', result.minSpo2, '- ä¾†æº:', spo2ConclusionMatch[0]);
            }
            
            // å„ªå…ˆç´š2: è¶…å¼·å¤šé‡æ¨¡å¼éšå±¤å¼åŒ¹é…
            if (result.minSpo2 === null) {
                console.log('ğŸ” ä½¿ç”¨è¶…å¼·å¤šé‡æ¨¡å¼åŒ¹é…SpO2');
                
                const spo2SuperPatterns = [
                    {
                        name: "æ¨™æº–ä¸­æ–‡æ ¼å¼",
                        pattern: /æœ€[å°ä½]\s*SpO2\s*[ï¼š:=]?\s*\(?(\d+)/i,
                        description: "æœ€å°/æœ€ä½ SpO2ï¼Œæ”¯æ´æ¨™é»ç¬¦è™Ÿå’Œæ‹¬è™Ÿ"
                    },
                    {
                        name: "è‹±æ–‡æ ¼å¼", 
                        pattern: /(?:Min|minimum|Minimal|Lowest)\s*SpO2\s*[ï¼š:=]?\s*\(?(\d+)/i,
                        description: "Min/minimum/Minimal/Lowest SpO2"
                    },
                    {
                        name: "ç·¨ç¢¼å®¹éŒ¯æ ¼å¼",
                        pattern: /æœ€[å°ä½]\s*Sp[O0oQ][2ï¼’ï¼’2]\s*[ï¼š:=]?\s*\(?(\d+)/i,
                        description: "å®¹éŒ¯O/0/o/Qå’Œ2/ï¼’çš„ç·¨ç¢¼å•é¡Œ"
                    },
                    {
                        name: "å¾Œç½®æ ¼å¼",
                        pattern: /SpO2\s*æœ€[å°ä½]å€¼?\s*[ï¼š:=]?\s*\(?(\d+)/i,
                        description: "SpO2æœ€å°å€¼/æœ€ä½å€¼æ ¼å¼"
                    },
                    {
                        name: "è¡¨æ ¼åºåˆ—æ ¼å¼",
                        pattern: /å¹³å‡\s*SpO2.*?æœ€å¤§\s*SpO2.*?æœ€[å°ä½]\s*SpO2\s*[ï¼š:=]?\s*\(?(\d+)/i,
                        description: "å®Œæ•´è¡¨æ ¼åºåˆ—"
                    },
                    {
                        name: "ç·Šæ¹Šè¡¨æ ¼æ ¼å¼",
                        pattern: /å¹³å‡SpO2\s*[\d.]+\s*æœ€å¤§SpO2\s*\d+\s*æœ€[å°ä½]SpO2\s*(\d+)/i,
                        description: "ç„¡ç©ºæ ¼ç·Šæ¹Šè¡¨æ ¼"
                    },
                    {
                        name: "åˆ†éš”ç¬¦æ ¼å¼",
                        pattern: /æœ€[å°ä½]\s*SpO2[\s\|,\t]*(\d+)/i,
                        description: "å„ç¨®åˆ†éš”ç¬¦æ ¼å¼"
                    },
                    {
                        name: "ç¯„åœå€¼æ ¼å¼",
                        pattern: /æœ€[å°ä½]\s*SpO2\s*[ï¼š:=]?\s*(\d+)[-~]\d+/i,
                        description: "ç¯„åœå€¼ï¼Œå–ç¬¬ä¸€å€‹æ•¸"
                    },
                    {
                        name: "å¸¶å–®ä½æ ¼å¼",
                        pattern: /æœ€[å°ä½]\s*SpO2\s*[ï¼š:=]?\s*(\d+)\s*[%ï¼…]/i,
                        description: "æ˜ç¢ºæ¨™è¨»ç™¾åˆ†æ¯”ç¬¦è™Ÿ"
                    },
                    {
                        name: "æ›è¡Œåˆ†éš”æ ¼å¼",
                        pattern: /æœ€[å°ä½]\s*SpO2\s*\n\s*(\d+)/i,
                        description: "æ›è¡Œåˆ†éš”çš„æ•¸å€¼"
                    },
                    {
                        name: "è¡€æ°§é£½å’Œåº¦æ ¼å¼",
                        pattern: /(?:è¡€æ°§é£½å’Œåº¦|æ°§é£½å’Œåº¦)\s*æœ€[å°ä½]\s*[ï¼š:=]?\s*(\d+)/i,
                        description: "ä¸­æ–‡è¡€æ°§é£½å’Œåº¦è¡¨é”"
                    },
                    {
                        name: "Saturationæ ¼å¼",
                        pattern: /(?:oxygen\s*saturation|O2\s*saturation)\s*(?:min|minimum|lowest)\s*[ï¼š:=]?\s*(\d+)/i,
                        description: "è‹±æ–‡è¡€æ°§é£½å’Œåº¦"
                    },
                    {
                        name: "å€’åºæ ¼å¼",
                        pattern: /(\d+)\s*[ï¼š:=]?\s*æœ€[å°ä½]\s*SpO2/i,
                        description: "æ•¸å€¼åœ¨å‰çš„å€’åºæ ¼å¼"
                    },
                    {
                        name: "æ‹¬è™Ÿå…§æ ¼å¼",
                        pattern: /SpO2\s*\([^)]*æœ€[å°ä½][^)]*(\d+)[^)]*\)/i,
                        description: "æ‹¬è™Ÿå…§çš„æè¿°æ ¼å¼"
                    },
                    {
                        name: "å…¨å½¢å­—ç¬¦æ ¼å¼",
                        pattern: /æœ€[å°ä½]ã€€ï¼³ï½ï¼¯ï¼’\s*[ï¼š:=]?\s*(\d+)/i,
                        description: "å…¨å½¢å­—ç¬¦æ ¼å¼"
                    },
                    {
                        name: "ç°¡å¯«æ ¼å¼",
                        pattern: /min\s*SpO2\s*[ï¼š:=]?\s*(\d+)/i,
                        description: "min SpO2ç°¡å¯«"
                    },
                    {
                        name: "æ¨¡ç³Šæ•¸å­—åŒ¹é…",
                        pattern: /(?:æœ€[å°ä½]|Min|minimum).*?(?:SpO2|Sp02|è¡€æ°§).*?(\d+)/i,
                        description: "æ¨¡ç³ŠåŒ¹é…é—œéµè©å’Œæ•¸å­—"
                    },
                    {
                        name: "è¡¨æ ¼åˆ—æ ¼å¼",
                        pattern: /æœ€[å°ä½].*?\n.*?SpO2.*?\n.*?(\d+)/i,
                        description: "å¤šè¡Œè¡¨æ ¼åˆ—æ ¼å¼"
                    },
                    {
                        name: "æ•¸å€¼å„ªå…ˆæ ¼å¼",
                        pattern: /(\d{2})\s*(?:%|ï¼…)?\s*(?:æœ€[å°ä½])?.*?SpO2/i,
                        description: "ä»¥å…©ä½æ•¸é–‹é ­çš„æ ¼å¼"
                    }
                ];
                
                for (let i = 0; i < spo2SuperPatterns.length; i++) {
                    const patternInfo = spo2SuperPatterns[i];
                    const match = pdfText.match(patternInfo.pattern);
                    
                    if (match) {
                        const val = parseInt(match[1]);
                        console.log(`åŒ¹é…æ¨¡å¼${i+1}: ${patternInfo.name}`);
                        console.log(`åŒ¹é…çµæœ: "${match[0]}" â†’ æ•¸å€¼: ${val}`);
                        
                        // æ•¸å€¼åˆç†æ€§æª¢æŸ¥
                        if (val >= 50 && val <= 100) {
                            result.minSpo2 = val;
                            console.log(`âœ… [å„ªå…ˆç´š2-æ¨¡å¼${i+1}] æå–SpO2:`, result.minSpo2, '%');
                            break;
                        } else if (val >= 0 && val <= 50) {
                            // å¯èƒ½æ˜¯å°æ•¸æ ¼å¼ 0.74 -> 74
                            const possibleVal = val * 100;
                            if (possibleVal >= 50 && possibleVal <= 100) {
                                result.minSpo2 = possibleVal;
                                console.log(`âœ… [å„ªå…ˆç´š2-æ¨¡å¼${i+1}] å°æ•¸è½‰æ›SpO2: ${val} â†’ ${possibleVal}%`);
                                break;
                            } else {
                                console.log(`âš ï¸ æ•¸å€¼${val}è½‰æ›å¾Œä»è¶…å‡ºç¯„åœï¼Œç¹¼çºŒå˜—è©¦å…¶ä»–æ¨¡å¼`);
                            }
                        } else {
                            console.log(`âš ï¸ æ•¸å€¼${val}è¶…å‡ºåˆç†ç¯„åœ(50-100)ï¼Œç¹¼çºŒå˜—è©¦å…¶ä»–æ¨¡å¼`);
                        }
                    } else {
                        console.log(`æ¨¡å¼${i+1} (${patternInfo.name}): æœªåŒ¹é…`);
                    }
                }
            }
            
            // å„ªå…ˆç´š3: æ¥µç«¯æƒ…æ³çš„æš´åŠ›åŒ¹é…
            if (result.minSpo2 === null) {
                console.log('ğŸ”„ ä½¿ç”¨æ¥µç«¯æƒ…æ³æš´åŠ›åŒ¹é…SpO2');
                
                // æå–æ‰€æœ‰å¯èƒ½çš„å…©ä½æ•¸å­—ï¼Œç„¶å¾ŒåŸºæ–¼ä¸Šä¸‹æ–‡åˆ¤æ–·
                const numberMatches = [...pdfText.matchAll(/(\d{2,3})/g)];
                const contextualNumbers = [];
                
                numberMatches.forEach((match, index) => {
                    const number = parseInt(match[1]);
                    const startPos = match.index;
                    const endPos = startPos + match[0].length;
                    
                    // æå–æ•¸å­—å‰å¾Œçš„ä¸Šä¸‹æ–‡
                    const beforeContext = pdfText.substring(Math.max(0, startPos - 50), startPos).toLowerCase();
                    const afterContext = pdfText.substring(endPos, Math.min(pdfText.length, endPos + 50)).toLowerCase();
                    const fullContext = beforeContext + afterContext;
                    
                    // æª¢æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦åŒ…å«SpO2ç›¸é—œé—œéµè©
                    const hasSpO2Context = /spo2|sp02|è¡€æ°§|oxygen|saturation/.test(fullContext);
                    const hasMinContext = /æœ€å°|æœ€ä½|min|minimum|lowest/.test(fullContext);
                    
                    if (hasSpO2Context && hasMinContext && number >= 50 && number <= 100) {
                        contextualNumbers.push({
                            number,
                            context: fullContext,
                            confidence: (hasSpO2Context ? 1 : 0) + (hasMinContext ? 1 : 0)
                        });
                    }
                });
                
                if (contextualNumbers.length > 0) {
                    // é¸æ“‡ä¿¡å¿ƒåº¦æœ€é«˜çš„æ•¸å­—
                    const bestMatch = contextualNumbers.sort((a, b) => b.confidence - a.confidence)[0];
                    result.minSpo2 = bestMatch.number;
                    console.log(`âœ… [æ¥µç«¯åŒ¹é…] åŸºæ–¼ä¸Šä¸‹æ–‡æå–SpO2: ${result.minSpo2}% (ä¿¡å¿ƒåº¦: ${bestMatch.confidence})`);
                    console.log(`ä¸Šä¸‹æ–‡: "${bestMatch.context.trim()}"`);
                }
            }
            
            // å„ªå…ˆç´š4: å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼Œè©³ç´°èª¿è©¦åˆ†æ
            if (result.minSpo2 === null) {
                console.log('âš ï¸ æ‰€æœ‰SpO2åŒ¹é…æ¨¡å¼éƒ½å¤±æ•—ï¼Œé€²è¡Œè©³ç´°èª¿è©¦åˆ†æ');
                
                // æª¢æŸ¥PDFå…§å®¹ä¸­æ‰€æœ‰å¯èƒ½çš„SpO2è®Šé«”
                const spO2Variants = [
                    'SpO2', 'Sp02', 'SpOï¼’', 'ï¼³ï½ï¼¯ï¼’', 'spo2', 'SPO2',
                    'è¡€æ°§', 'æ°§é£½å’Œ', 'oxygen', 'saturation', 'O2 sat'
                ];
                
                const foundVariants = [];
                spO2Variants.forEach(variant => {
                    if (pdfText.includes(variant)) {
                        foundVariants.push(variant);
                    }
                });
                
                console.log('PDFä¸­æ‰¾åˆ°çš„SpO2è®Šé«”:', foundVariants);
                
                // æå–åŒ…å«SpO2ç›¸é—œå…§å®¹çš„æ‰€æœ‰è¡Œ
                const relevantLines = pdfText.split(/[\n\r]+/).filter(line => {
                    return spO2Variants.some(variant => 
                        line.toLowerCase().includes(variant.toLowerCase())
                    );
                });
                
                if (relevantLines.length > 0) {
                    console.log('åŒ…å«SpO2çš„æ‰€æœ‰æ–‡å­—è¡Œ:');
                    relevantLines.forEach((line, index) => {
                        console.log(`  ${index + 1}. "${line.trim()}"`);
                    });
                    
                    // å˜—è©¦å¾é€™äº›è¡Œä¸­æå–æ•¸å­—
                    console.log('å˜—è©¦å¾ç›¸é—œè¡Œä¸­æå–æ•¸å­—:');
                    relevantLines.forEach((line, index) => {
                        const numbers = [...line.matchAll(/(\d{2,3})/g)];
                        if (numbers.length > 0) {
                            console.log(`  ç¬¬${index + 1}è¡Œæ•¸å­—:`, numbers.map(m => m[1]).join(', '));
                        }
                    });
                } else {
                    console.log('PDFä¸­æœªç™¼ç¾ä»»ä½•SpO2ç›¸é—œå…§å®¹');
                }
                
                // å¦‚æœçœŸçš„æ‰¾ä¸åˆ°ï¼Œçµ¦å‡ºå»ºè­°
                console.log('ğŸ’¡ å»ºè­°: è«‹æª¢æŸ¥PDFæ ¼å¼æ˜¯å¦æ¨™æº–ï¼Œæˆ–è¯ç¹«é–‹ç™¼è€…æ·»åŠ æ–°çš„åŒ¹é…æ¨¡å¼');
            }
            
            // 7. äº¤å‰é©—è­‰å’Œæ™ºèƒ½ä¿®æ­£
            console.log('\nğŸ”§ åŸ·è¡Œäº¤å‰é©—è­‰å’Œæ™ºèƒ½ä¿®æ­£');
            
            // æª¢æŸ¥æ˜¯å¦å¾çµè«–ä¸­æ‰¾åˆ°æ›´å¯é çš„æ•¸æ“š
            const conclusionMatch = pdfText.match(/ODI3%=(\d+).*?æœ€ä½SpO2=(\d+)%.*?T90=(\d+)%/i);
            if (conclusionMatch) {
                console.log('ğŸ¯ ç™¼ç¾çµè«–æ€§æ•¸æ“šï¼Œé€²è¡Œäº¤å‰é©—è­‰:');
                console.log('çµè«–ODI3%:', conclusionMatch[1]);
                console.log('çµè«–æœ€ä½SpO2:', conclusionMatch[2]);
                console.log('çµè«–T90:', conclusionMatch[3]);
                
                // å¦‚æœçµè«–æ•¸æ“šèˆ‡æå–æ•¸æ“šå·®ç•°å¾ˆå¤§ï¼Œå„ªå…ˆä½¿ç”¨çµè«–æ•¸æ“š
                const conclusionODI3 = parseInt(conclusionMatch[1]);
                const conclusionSpO2 = parseInt(conclusionMatch[2]);
                const conclusionT90 = parseInt(conclusionMatch[3]);
                
                if (result.odi3 !== null && Math.abs(result.odi3 - conclusionODI3) > 5) {
                    console.log('âš ï¸ ODI3%æ•¸æ“šå·®ç•°è¼ƒå¤§ï¼Œä½¿ç”¨çµè«–æ•¸æ“š:', conclusionODI3);
                    result.odi3 = conclusionODI3;
                }
                
                if (result.minSpo2 !== null && Math.abs(result.minSpo2 - conclusionSpO2) > 2) {
                    console.log('âš ï¸ SpO2æ•¸æ“šå·®ç•°è¼ƒå¤§ï¼Œä½¿ç”¨çµè«–æ•¸æ“š:', conclusionSpO2);
                    result.minSpo2 = conclusionSpO2;
                }
                
                if (result.t90 !== null && Math.abs(result.t90 - conclusionT90) > 3) {
                    console.log('âš ï¸ T90æ•¸æ“šå·®ç•°è¼ƒå¤§ï¼Œä½¿ç”¨çµè«–æ•¸æ“š:', conclusionT90);
                    result.t90 = conclusionT90;
                }
                
                // å¦‚æœæŸäº›æ•¸æ“šä»ç„¶ç‚ºç©ºï¼Œä½¿ç”¨çµè«–æ•¸æ“š
                if (result.odi3 === null) result.odi3 = conclusionODI3;
                if (result.minSpo2 === null) result.minSpo2 = conclusionSpO2;
                if (result.t90 === null) result.t90 = conclusionT90;
            }
            
            console.log('\n=== æ™ºèƒ½æå–å®Œæˆ ===');
            console.log('æœ€çµ‚çµæœ:', {
                å§“å: result.patientName,
                è¨˜éŒ„æ™‚é–“: result.recordTime,
                åˆ—å°æ—¥æœŸ: result.printDate,
                'ODI 3%': result.odi3,
                'T90æ™‚é–“ç™¾åˆ†æ¯”': result.t90,
                'æœ€å°SpO2': result.minSpo2
            });
            
            return result;
        }
        
        function calculateRiskFromExtractedData(data, fileName) {
            // æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
            const missingData = [];
            if (data.minSpo2 === null || data.minSpo2 === undefined) missingData.push('æœ€å°SpO2');
            if (data.odi3 === null || data.odi3 === undefined) missingData.push('ODI 3%');
            if (data.t90 === null || data.t90 === undefined) missingData.push('T90');
            
            if (missingData.length === 3) {
                throw new Error('ç„¡æ³•å¾PDFä¸­æå–ä»»ä½•é—œéµæ•¸æ“šï¼Œè«‹æª¢æŸ¥PDFæ ¼å¼æˆ–å…§å®¹');
            }
            
            // è¨ˆç®—è©•åˆ† (ç¼ºå¤±çš„æ•¸æ“šç•¶ä½œ0åˆ†)
            const odi3Score = data.odi3 !== null && data.odi3 !== undefined ? calculateODI3Score(data.odi3) : 0;
            const spo2Score = data.minSpo2 !== null && data.minSpo2 !== undefined ? calculateSpO2Score(data.minSpo2) : 0;
            const t90Score = data.t90 !== null && data.t90 !== undefined ? calculateT90Score(data.t90) : 0;
            const totalScore = odi3Score + spo2Score + t90Score;
            
            let riskLevel;
            if (totalScore <= 3) {
                riskLevel = 'ä½é¢¨éšª';
            } else if (totalScore <= 7) {
                riskLevel = 'ä¸­åº¦é¢¨éšª';
            } else {
                riskLevel = 'é«˜åº¦é¢¨éšª';
            }
            
            // ä½¿ç”¨æå–çš„æ‚£è€…å§“åï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨æª”å
            let patientName = data.patientName || fileName.replace(/\.pdf$/i, '');
            
            return {
                fileName: fileName,
                patientName: patientName,
                recordTime: data.recordTime || 'æœªçŸ¥',
                printDate: data.printDate || 'æœªçŸ¥',
                odi3: data.odi3, // ä¿æŒåŸå§‹æ•¸å€¼
                minSpo2: data.minSpo2, // ä¿æŒåŸå§‹æ•¸å€¼
                t90: data.t90, // ä¿æŒåŸå§‹æ•¸å€¼
                odi3Score,
                spo2Score,
                t90Score,
                totalScore,
                riskLevel,
                processDate: new Date().toLocaleDateString('zh-TW'),
                missingData: missingData.length > 0 ? missingData : null
            };
        }
        
        function formatDateTime(value) {
            if (value instanceof Date) {
                return value.toLocaleString('zh-TW');
            } else if (typeof value === 'number') {
                // Excel æ—¥æœŸæ˜¯å¾ 1900/1/1 é–‹å§‹çš„å¤©æ•¸
                const excelEpoch = new Date(1900, 0, 1);
                const date = new Date(excelEpoch.getTime() + (value - 2) * 24 * 60 * 60 * 1000);
                return date.toLocaleString('zh-TW');
            } else if (typeof value === 'string') {
                return value;
            }
            return 'ç„¡è³‡æ–™';
        }
        
        function displayBatchResults() {
            const successResults = processedResults.filter(r => !r.error);
            
            // çµ±è¨ˆæ‘˜è¦
            const noRisk = successResults.filter(r => r.riskLevel === 'ä½é¢¨éšª').length;
            const mediumRisk = successResults.filter(r => r.riskLevel === 'ä¸­åº¦é¢¨éšª').length;
            const highRisk = successResults.filter(r => r.riskLevel === 'é«˜åº¦é¢¨éšª').length;
            
            const summaryHTML = `
                <div class="summary-card no-risk">
                    <div class="summary-number">${noRisk}</div>
                    <div class="summary-label">ä½é¢¨éšªæ‚£è€…</div>
                </div>
                <div class="summary-card medium-risk">
                    <div class="summary-number">${mediumRisk}</div>
                    <div class="summary-label">ä¸­åº¦é¢¨éšªæ‚£è€…</div>
                </div>
                <div class="summary-card high-risk">
                    <div class="summary-number">${highRisk}</div>
                    <div class="summary-label">é«˜åº¦é¢¨éšªæ‚£è€…</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${successResults.length}</div>
                    <div class="summary-label">ç¸½è™•ç†æ•¸é‡</div>
                </div>
            `;
            
            document.getElementById('resultsSummary').innerHTML = summaryHTML;
            
            // çµæœè¡¨æ ¼
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶åç¨±</th>
                            <th>æ‚£è€…å§“å</th>
                            <th>è¨˜éŒ„æ™‚é–“</th>
                            <th>åˆ—å°æ—¥æœŸ</th>
                            <th>ODI 3%<br/>æ¯å°æ™‚é »ç‡</th>
                            <th>æœ€å°SpO2</th>
                            <th>T90<br/>æ™‚é–“ç™¾åˆ†æ¯”</th>
                            <th>ç¸½åˆ†</th>
                            <th>é¢¨éšªç­‰ç´š</th>
                            <th>å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${processedResults.map(result => {
                            if (result.error) {
                                return `
                                    <tr>
                                        <td>${result.fileName}</td>
                                        <td colspan="9" style="color: #e74c3c;">è™•ç†å¤±æ•—: ${result.errorMessage}</td>
                                    </tr>
                                `;
                            }
                            
                            const riskClass = result.riskLevel === 'ä½é¢¨éšª' ? 'no-risk' : 
                                            result.riskLevel === 'ä¸­åº¦é¢¨éšª' ? 'medium-risk' : 'high-risk';
                            
                            const noteText = result.missingData ? 
                                `ç¼ºå°‘: ${result.missingData.join(', ')}` : 'æ•¸æ“šå®Œæ•´';
                            
                            // ç¢ºä¿é¡¯ç¤ºæ­£ç¢ºçš„æ•¸å€¼æ ¼å¼
                            const displayOdi3 = result.odi3 !== null && result.odi3 !== undefined ? result.odi3 : 'ç„¡è³‡æ–™';
                            const displayMinSpo2 = result.minSpo2 !== null && result.minSpo2 !== undefined ? 
                                `${result.minSpo2}%` : 'ç„¡è³‡æ–™';
                            const displayT90 = result.t90 !== null && result.t90 !== undefined ? 
                                `${result.t90}%` : 'ç„¡è³‡æ–™';
                            
                            return `
                                <tr>
                                    <td>${result.fileName}</td>
                                    <td>${result.patientName || 'æœªçŸ¥'}</td>
                                    <td style="font-size: 12px;">${result.recordTime || 'æœªçŸ¥'}</td>
                                    <td style="font-size: 12px;">${result.printDate || 'æœªçŸ¥'}</td>
                                    <td>${displayOdi3}</td>
                                    <td>${displayMinSpo2}</td>
                                    <td>${displayT90}</td>
                                    <td><strong>${result.totalScore}</strong></td>
                                    <td><span class="risk-badge ${riskClass}">${result.riskLevel}</span></td>
                                    <td style="font-size: 12px; color: ${result.missingData ? '#e74c3c' : '#27ae60'};">${noteText}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('resultsTable').innerHTML = tableHTML;
            document.getElementById('batchResults').style.display = 'block';
        }
        
        function calculateODI3Score(value) {
            if (value >= 25) return 6;
            if (value >= 15) return 5;
            if (value >= 10) return 4;
            if (value >= 5) return 3;
            if (value >= 3) return 2;
            if (value >= 1) return 1;
            return 0;
        }
        
        function calculateSpO2Score(value) {
            if (value < 70) return 5;
            if (value < 75) return 4;
            if (value < 80) return 3;
            if (value < 85) return 2;
            if (value < 88) return 1;
            return 0;
        }
        
        function calculateT90Score(value) {
            if (value > 15) return 4;
            if (value > 10) return 3;
            if (value > 5) return 2;
            if (value > 0) return 1;
            return 0;
        }
        
        function updateScores() {
            const odi3 = parseFloat(document.getElementById('odi3').value);
            const minSpo2 = parseFloat(document.getElementById('minSpo2').value);
            const t90 = parseFloat(document.getElementById('t90').value);
            
            // åªæœ‰ç•¶æœ‰å€¼æ™‚æ‰è¨ˆç®—åˆ†æ•¸ï¼Œå¦å‰‡é¡¯ç¤º0
            const odi3Score = !isNaN(odi3) ? calculateODI3Score(odi3) : 0;
            const spo2Score = !isNaN(minSpo2) ? calculateSpO2Score(minSpo2) : 0;
            const t90Score = !isNaN(t90) ? calculateT90Score(t90) : 0;
            
            document.getElementById('odi3Score').textContent = odi3Score;
            document.getElementById('spo2Score').textContent = spo2Score;
            document.getElementById('t90Score').textContent = t90Score;
        }
        
        function calculateRisk() {
            // é©—è­‰æ˜¯å¦æœ‰è¼¸å…¥æ•¸å€¼
            const odi3Value = document.getElementById('odi3').value.trim();
            const minSpo2Value = document.getElementById('minSpo2').value.trim();
            const t90Value = document.getElementById('t90').value.trim();
            
            // æª¢æŸ¥æ˜¯å¦è‡³å°‘è¼¸å…¥ä¸€å€‹æ•¸å€¼
            if (!odi3Value && !minSpo2Value && !t90Value) {
                alert('âš ï¸ è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æª¢æ¸¬æ•¸å€¼æ‰èƒ½é€²è¡Œé¢¨éšªè©•ä¼°ï¼');
                return;
            }
            
            updateScores();
            
            const odi3Score = parseInt(document.getElementById('odi3Score').textContent);
            const spo2Score = parseInt(document.getElementById('spo2Score').textContent);
            const t90Score = parseInt(document.getElementById('t90Score').textContent);
            
            const totalScore = odi3Score + spo2Score + t90Score;
            
            let riskLevel, riskColor, recommendation;
            
            if (totalScore <= 3) {
                riskLevel = 'ä½é¢¨éšª';
                riskColor = '#3F7B7B';
                recommendation = 'å¹´åº¦å®šæœŸè¿½è¹¤å³å¯ã€‚ç¶­æŒå¥åº·ç”Ÿæ´»å‹æ…‹ï¼Œæ³¨æ„é«”é‡æ§åˆ¶ã€‚è‹¥å‡ºç¾æ‰“é¼¾åŠ é‡æˆ–æ—¥é–“å—œç¡ç—‡ç‹€ï¼Œå»ºè­°æå‰å›æª¢ã€‚';
            } else if (totalScore <= 7) {
                riskLevel = 'ä¸­åº¦é¢¨éšª';
                riskColor = '#A8A093';
                recommendation = 'å»ºè­°3-6å€‹æœˆå…§è¿½è¹¤æª¢æŸ¥ã€‚ç©æ¥µé€²è¡Œç”Ÿæ´»å‹æ…‹èª¿æ•´ï¼šæ¸›é‡ã€æˆ’è¸ã€é¿å…é£²é…’ã€æ¡å´ç¡å§¿å‹¢ã€‚è€ƒæ…®å®‰æ’ç°¡æ˜“å±…å®¶ç¡çœ æª¢æŸ¥ã€‚';
            } else {
                riskLevel = 'é«˜åº¦é¢¨éšª';
                riskColor = '#D66B50';
                let urgency = '';
                if (totalScore >= 12) {
                    urgency = 'æ¥µé«˜é¢¨éšª - å»ºè­°1é€±å…§è½‰ä»‹ç¡çœ å°ˆç§‘é†«å¸«ã€‚';
                } else if (totalScore >= 9) {
                    urgency = 'é«˜é¢¨éšª - å»ºè­°2é€±å…§è½‰ä»‹ç¡çœ å°ˆç§‘é†«å¸«ã€‚';
                } else {
                    urgency = 'ä¸­é«˜é¢¨éšª - å»ºè­°1å€‹æœˆå…§å®‰æ’é€²ä¸€æ­¥æª¢æŸ¥ã€‚';
                }
                recommendation = urgency + 'ç«‹å³å®‰æ’å®Œæ•´ç¡çœ æª¢æŸ¥(PSG)ï¼Œè©•ä¼°CPAPå‘¼å¸å™¨æ²»ç™‚éœ€æ±‚ï¼Œä¸¦ç›£æ¸¬å¿ƒè¡€ç®¡ä½µç™¼ç—‡é¢¨éšªã€‚';
            }
            
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('totalScore').style.color = riskColor;
            document.getElementById('riskLevel').textContent = riskLevel;
            document.getElementById('riskLevel').style.color = riskColor;
            document.getElementById('recommendationText').textContent = recommendation;
            
            // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
            const indicator = document.getElementById('scoreIndicator');
            const position = (totalScore / 14) * 100;
            indicator.style.left = position + '%';
            
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            
            // æ›´æ–°åŒ¯å‡ºç”¨çš„æ‚£è€…è³‡è¨Šé¡¯ç¤º
            document.getElementById('displayPatientName').textContent = 
                document.getElementById('patientName').value || 'æœªå¡«å¯«';
            document.getElementById('displayAssessmentDate').textContent = 
                document.getElementById('assessmentDate').value || 'æœªå¡«å¯«';

        }
        
        // æ·»åŠ è¼¸å…¥ç›£è½å™¨ä»¥å³æ™‚æ›´æ–°åˆ†æ•¸
        document.getElementById('odi3').addEventListener('input', updateScores);
        document.getElementById('minSpo2').addEventListener('input', updateScores);
        document.getElementById('t90').addEventListener('input', updateScores);

        function exportToExcel() {
            if (processedResults.length === 0) {
                alert('æ²’æœ‰å¯åŒ¯å‡ºçš„æ•¸æ“šï¼');
                return;
            }
            
            // æº–å‚™Excelæ•¸æ“š
            const excelData = [];
            
            // æ¨™é¡Œè¡Œ
            excelData.push([
                'æ–‡ä»¶åç¨±',
                'æ‚£è€…å§“å', 
                'è¨˜éŒ„æ™‚é–“',
                'åˆ—å°æ—¥æœŸ',
                'ODI 3% (æ¯å°æ™‚é »ç‡)',
                'æœ€å°SpO2 (%)',
                'T90 æ™‚é–“ç™¾åˆ†æ¯” (%)',
                'ODI 3% åˆ†æ•¸',
                'SpO2 åˆ†æ•¸', 
                'T90 åˆ†æ•¸',
                'ç¸½åˆ†',
                'é¢¨éšªç­‰ç´š',
                'è™•ç†æ—¥æœŸ',
                'å‚™è¨»'
            ]);
            
            // æ•¸æ“šè¡Œ
            processedResults.forEach(result => {
                if (!result.error) {
                    const noteText = result.missingData ? 
                        `ç¼ºå°‘: ${result.missingData.join(', ')}` : 'æ•¸æ“šå®Œæ•´';
                        
                    excelData.push([
                        result.fileName,
                        result.patientName || 'æœªçŸ¥',
                        result.recordTime || 'æœªçŸ¥',
                        result.printDate || 'æœªçŸ¥',
                        result.odi3 !== null ? result.odi3 : 'ç„¡è³‡æ–™',
                        result.minSpo2 !== null ? result.minSpo2 : 'ç„¡è³‡æ–™',
                        result.t90 !== null ? result.t90 : 'ç„¡è³‡æ–™',
                        result.odi3Score,
                        result.spo2Score,
                        result.t90Score,
                        result.totalScore,
                        result.riskLevel,
                        result.processDate,
                        noteText
                    ]);
                } else {
                    excelData.push([
                        result.fileName,
                        'è™•ç†å¤±æ•—',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        result.errorMessage
                    ]);
                }
            });
            
            // å‰µå»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // è¨­ç½®åˆ—å¯¬
            const colWidths = [
                {wch: 20}, // æ–‡ä»¶åç¨±
                {wch: 12}, // æ‚£è€…å§“å
                {wch: 18}, // è¨˜éŒ„æ™‚é–“
                {wch: 15}, // åˆ—å°æ—¥æœŸ
                {wch: 12}, // ODI 3%
                {wch: 12}, // æœ€å°SpO2
                {wch: 12}, // T90
                {wch: 10}, // ODI 3% åˆ†æ•¸
                {wch: 10}, // SpO2 åˆ†æ•¸
                {wch: 10}, // T90 åˆ†æ•¸
                {wch: 8},  // ç¸½åˆ†
                {wch: 12}, // é¢¨éšªç­‰ç´š
                {wch: 12}, // è™•ç†æ—¥æœŸ
                {wch: 15}  // å‚™è¨»
            ];
            ws['!cols'] = colWidths;
            
            // å‰µå»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "OSAé¢¨éšªè©•ä¼°çµæœ");
            
            // ç”Ÿæˆæ–‡ä»¶å
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0,8).replace(/:/g, '');
            const fileName = `OSAé¢¨éšªè©•ä¼°çµæœ_${dateStr}_${timeStr}.xlsx`;
            
            // ä¸‹è¼‰æ–‡ä»¶
            XLSX.writeFile(wb, fileName);
        }

    </script>
</body>
</html>
